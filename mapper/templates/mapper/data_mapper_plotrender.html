{% extends "home/base.html" %}
{% load static %}
{% load humanize %}
{% block addon_css %}
<link rel="stylesheet" href="{% static 'home/css/nv.d3.min.css' %}" type="text/css" />
<link rel="stylesheet" href="{% static 'home/css/nvd3-update.css' %}" type="text/css" />
<link href="{% static 'home/css/bootstrap-responsive.css' %}" rel="stylesheet" media="screen">

{% endblock %}

{% block content %}
<style>
    #circle_lightgray {
        width: 10px;
        height: 10px;
        -webkit-border-radius: 5px;
        -moz-border-radius: 5px;
        border-radius: 5px;
        background: LightGray;
    }
    #circle_darkgray {
        width: 10px;
        height: 10px;
        -webkit-border-radius: 5px;
        -moz-border-radius: 5px;
        border-radius: 5px;
        background: DarkGray;
    }
    #circle_gray {
        width: 10px;
        height: 10px;
        -webkit-border-radius: 5px;
        -moz-border-radius: 5px;
        border-radius: 5px;
        background: Gray;
    }
    #circle_black {
        width: 10px;
        height: 10px;
        -webkit-border-radius: 5px;
        -moz-border-radius: 5px;
        border-radius: 5px;
        background: Black;
    }
    .gprot_orange {
      color: orange;
    }

    .gprot_blue {
      color: blue;
    }

    .gprot_red {
      color: red;
    }

    .gprot_black {
      color: black;
    }

    .gprot_green {
      color: forestgreen;
    }
    .graydiv {
        height: 20px;
        width: 350px;
        background: linear-gradient(to right, white 0%, black 100%)
    }
    .svg-container {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #plotContainer_umap {
        width: 800px; /* Set width */
        height: 600px; /* Set height */
        margin: auto; /* Center the plot */
    }
</style>
<div class='col-md-12'>
  <br />
  <h3 style='text-align:center;'>Data Mapper Plots</h3>
  <br \>
</div>

<!-- ### Create the panel tabs ### -->
<ul class="nav nav-tabs">
  {% if Plot_evaluation_json.0 %}
    <li class="{% if first_active_tab == '#tab1' %}active{% endif %}">
      <a href="#tab1" data-toggle="tab">Phylogenetic Tree</a>
    </li>
  {% endif %}
  {% if Plot_evaluation_json.1 %}
    <li class="{% if first_active_tab == '#tab2' %}active{% endif %}">
      <a href="#tab2" data-toggle="tab">Cluster Analysis</a>
    </li>
  {% endif %}
  {% if Plot_evaluation_json.2 %}
    <li class="{% if first_active_tab == '#tab3' %}active{% endif %}">
      <a href="#tab3" data-toggle="tab">List Plot</a>
    </li>
  {% endif %}
  {% if Plot_evaluation_json.3 %}
    <li class="{% if first_active_tab == '#tab4' %}active{% endif %}">
      <a href="#tab4" data-toggle="tab">Heatmap</a>
    </li>
  {% endif %}
</ul>

<!-- ## Tab content ## -->
<div class="tab-content">
  <!-- ## Tab 1 - Phylogenetic Tree ## -->
  {% if Plot_evaluation_json.0 %}
  <div id="tab1" class="tab-pane fade {% if first_active_tab == '#tab1' %}in active{% endif %}">
    <div style="padding-top: 10px; font-size: 11px; white-space: nowrap;">
      <div>
        <div style="padding-top: 5px;">
          Receptor names:
            <div class="btn-group" role="group" id="gtp_plus">
                <button id="UniProtNames" class="btn btn-info active">UniProt</button>
                <button id="IUPHARNames" class="btn btn-info">IUPHAR</button>
            </div>
        </div>
        <br />
        Inner circle colors (TBD):
        <table style="width:30%">
            <tr>
                <td ><div id="circle_lightgray"></div></td>
                <td> < XX </td>
                <td ><div id="circle_darkgray"></div></td>
                <td> < YY </td>
                <td ><div id="circle_gray"></div></td>
                <td> < ZZ </td>
                <td ><div id="circle_black"></div></td>
                <td> ZZ+</td>
            </tr>
        </table>
        <br />
        <div style="float: left; position: relative" class="text-center">
          <b>Features</b> <br />
            <span class="gprot_blue">Feature 1</span>
            <span class="gprot_red">Feature 2</span>
            <span class="gprot_black">Feature 3</span>
            <span class="gprot_green">Feature 4</span>
            <span class="gprot_orange">Feature 5</span>
        </div>
        <div style="float: right;" class="text-center">
          <b>Feature! (from low to high)</b>
          <div class="graydiv"></div>
        </div>
        <div class="row-fluid">
          <div class="span12">
            <div id="tree_plot" class="text-center">
              <h4>Tree Plot (Data Mapper)</h4>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  <!-- ## Tab 2 - Cluster Analysis ## -->
  {% if Plot_evaluation_json.1 %}
    <div id="tab2" class="tab-pane fade {% if first_active_tab == '#tab2' %}in active{% endif %}">
      <div style="padding-top: 10px; font-size: 11px; white-space: nowrap;">
        <div style="padding-top: 5px;">
          Color by:
            <div class="btn-group" role="group" id="gtp_plus">
              <button id="colorByCluster" class="btn btn-info active">Cluster</button>
              <button id="colorByGradient" class="btn btn-info">Gradient</button>
            </div>
        </div>
        <div style="padding-top: 5px;">
          Plot labels:
            <div class="btn-group" role="group" id="gtp_plus">
                <button id="show" class="btn btn-info active">Show</button>
                <button id="hide" class="btn btn-info">Hide</button>
            </div>
        </div>

      <!-- Container for the Plotly Plot -->
      <div id="plotContainer_umap" style="width: 800px; height: 600px;"></div>

        <br />
          <br />
          <br />
        <br />
      </div>
      <div id="plotContainer_tsne" class="text-center">
        <br />
          <br />
          <br />
        <br />
      </div>
      <div id="plotContainer_pca" class="text-center">
        <br />
          <br />
          <br />
        <br />
      </div>
      </div>
    </div>
  {% endif %}
  <!-- ## Tab 3 - List Plot ## -->
  {% if Plot_evaluation_json.2 %}
    <div id="tab3" class="tab-pane fade {% if first_active_tab == '#tab3' %}in active{% endif %}">
      <div style="padding-top: 10px; font-size: 11px; white-space: nowrap;"></div>
      <div id="ListPlot" class="text-center">
        <br />
          <br />
            <h4>List Plot</h4>
          <br />
        <br />
      </div>
    </div>
  {% endif %}
  <!-- ## Tab 4 - Heatmap ## -->
  {% if Plot_evaluation_json.3 %}
    <div id="tab4" class="tab-pane fade {% if first_active_tab == '#tab4' %}in active{% endif %}">
      <div style="padding-top: 10px; font-size: 11px; white-space: nowrap;"></div>
      <div id="heatmapPlot" class="text-center">
        <br />
          <br />
            <h4>Heatmap</h4>
          <br />
        <br />
      </div>
      </div>
    </div>
  {% endif %}
</div>

{% endblock %}

{% block addon_js %}
<script src="{% static 'home/js/d3.min.js' %}"></script>
<script src="{% static 'home/js/nv.d3.min.js' %}"></script>
<!-- <script src="{% static 'home/js/d3v4.min.js' %}"></script> -->
<script src="{% static 'home/js/saveSvgAsPng.js' %}"></script>
<script src="{% static 'home/js/saveSvg.js' %}"></script>
<script src="{% static 'home/js/phylo_tree.js' %}"></script>
<script src="{% static 'home/js/datamapper.js' %}"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

{% if Plot_evaluation_json.0 %}
  <script type="text/javascript" charset="utf-8">
      tree_data = {{ tree | safe }};
      tree_options = {{ tree_options | safe }};
      circles = {{ circles|safe }};
      whole_dict = {{ whole_dict|safe }};
      maxLeafNodeLenght = 55;
      conversion = {"Outer1":"#0000FF",
                    "Outer2":"#FF0000",
                    "Outer3":"#000000",
                    "Outer4":"#008000",
                    "Outer5":"#FFA500"};

      $("#UniProtNames").click(function(){
          $("#UniProtNames").addClass("active");
          $("#IUPHARNames").removeClass("active");
          changeLeavesLabels("tree_plot", "UniProt", whole_dict);
          DrawCircles('tree_plot', circles, maxLeafNodeLenght, conversion, true, false);
      });
      $("#IUPHARNames").click(function() {
        $("#UniProtNames_bal").removeClass("active");
        $("#IUPHARNames_bal").addClass("active");
        changeLeavesLabels("tree_plot","IUPHAR", whole_dict);
        // DrawCircles('tree_plot',circles, maxLeafNodeLenght,conversion,true,false);
      });
      draw_tree(tree_data, tree_options);
      DrawCircles('tree_plot', circles, maxLeafNodeLenght, conversion, true, false);
      $("#tree_plot svg g").first().attr('transform', 'translate(620,650) scale(0.8,0.8) ');
      $("#tree_plot").attr('height', 110);
      $("#tree_plot").attr('width', 1110);

  </script>
{% endif %}

{% if Plot_evaluation_json.1 %}
<script>
$(document).ready(function() {
    var cluster_data = {{ cluster_data|safe }};
    var similarity_umap = {{ similarity_umap|safe }};
    // var similarity_tsne = {{ similarity_tsne|safe }};
    // var similarity_pca = {{ similarity_pca|safe }};
    // var identity_umap = {{ identity_umap|safe }};
    // var identity_tsne = {{ identity_tsne|safe }};
    // var identity_pca = {{ identity_pca|safe }};
    var cluster_plot = "{{ plot_type }}";
    // renderClusterPlot(similarity_umap, "#plotContainer_umap", 'UMAP');
    // renderClusterPlot(similarity_umap, "#plotContainer_tsne", 'Similarity UMAP');
    // renderClusterPlot(identity_umap, "#plotContainer_pca", 'Identity UMAP');
    // renderClusterPlot(cluster_data, "#plotContainer_umap", 'UMAP');

    // Predefined color palette
    const colorPalette = [
        '#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd',
        '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'
    ];

    // Assign colors to clusters based on a modulo operation
    const uniqueClusters = [...new Set(cluster_data.map(d => d.cluster))];
    const clusterColorMap = Object.fromEntries(uniqueClusters.map((cluster, i) => [cluster, colorPalette[i % colorPalette.length]]));

    const colorByCluster = cluster_data.map(d => clusterColorMap[d.cluster]);
    const colorByGradient = cluster_data.map(d => d.fill); // Assuming 'value' is the field for gradient

    const textPositions = ['middle left', 'top left', 'bottom left', 'top right', 'bottom right', 'middle right'];

    // Function to create traces based on coloring option and label visibility
    function createTraces(colorOption, showLabels) {
        if (colorOption === colorByCluster) {
            // Create a separate trace for each cluster
            return uniqueClusters.flatMap(cluster => {
                const clusterData = cluster_data.filter(d => d.cluster === cluster);
                const markerTrace = {
                    x: clusterData.map(d => d.x),
                    y: clusterData.map(d => d.y),
                    mode: 'markers',
                    type: 'scatter',
                    hoverinfo: 'none', // No hover info for legend markers
                    marker: {
                        size: 10,
                        symbol: 'circle',
                        color: clusterColorMap[cluster]
                    },
                    name: "Cluster " + cluster // Use cluster name for legend
                };

                const textTrace = showLabels ? {
                    x: clusterData.map(d => d.x),
                    y: clusterData.map(d => d.y),
                    mode: 'text',
                    type: 'scatter',
                    text: clusterData.map(d => d.label),
                    textposition: clusterData.map((_, i) => textPositions[i % textPositions.length]),
                    textfont: {
                        size: 12,
                        color: 'black'
                    },
                    hoverinfo: 'none', // No hover info for text
                    showlegend: false // Hide text trace from legend
                } : [];

                return showLabels ? [markerTrace, textTrace] : [markerTrace];
            });
        } else {
            // Create a single trace for gradient coloring
            const markerTrace = {
                x: cluster_data.map(d => d.x),
                y: cluster_data.map(d => d.y),
                mode: 'markers',
                type: 'scatter',
                marker: {
                    size: 10,
                    symbol: 'circle',
                    color: cluster_data.map(d => d.fill), // Assuming 'fill' is the gradient value
                    coloraxis: 'coloraxis'
                },
                hoverinfo: 'none', // No hover info for legend markers
                showlegend: false // Hide marker trace from legend, as we'll use a color bar
            };

            const textTrace = showLabels ? {
                x: cluster_data.map(d => d.x),
                y: cluster_data.map(d => d.y),
                mode: 'text',
                type: 'scatter',
                text: cluster_data.map(d => d.label),
                textposition: cluster_data.map((_, i) => textPositions[i % textPositions.length]),
                textfont: {
                    size: 12,
                    color: 'black'
                },
                hoverinfo: 'none', // No hover info for text
                showlegend: false // Hide text trace from legend
            } : [];

            // Determine the range of 'd.fill'
            const fillValues = cluster_data.map(d => d.fill);
            const minFill = Math.min(...fillValues);
            const maxFill = Math.max(...fillValues);
            const tickStep = (maxFill - minFill) / 3;
            const ticks = Array.from({ length: 4 }, (_, i) => minFill + i * tickStep);

            const colorBarTrace = {
                x: [null], // Dummy data for the legend entry
                y: [null], // Dummy data for the legend entry
                mode: 'markers',
                type: 'scatter',
                marker: {
                    size: 0, // No marker visible
                    colorbar: {
                        titleside: 'right',
                        thickness: 20,
                        len: 0.5, // Adjust length as needed
                        tickvals: ticks, // Calculated tick values
                        ticktext: ticks.map(t => t.toFixed(1)), // Tick labels
                    },
                    colorscale: 'RdBu', // Red to Blue through White color scale
                    showscale: true // Show the color scale
                },
                showlegend: false // Hide this trace itself from legend
            };

            return showLabels ? [markerTrace, textTrace, colorBarTrace] : [markerTrace, colorBarTrace];
        }
    }


    // Function to update plot based on active buttons
    function updatePlot() {
        // Determine active color option
        const colorOption = document.getElementById('colorByCluster').classList.contains('active') ? colorByCluster : colorByGradient;

        // Determine label visibility
        const showLabels = document.getElementById('show').classList.contains('active');

        // Create traces with current settings
        const traces = createTraces(colorOption, showLabels);

        // Update the layout ticks for the color axis
        if (colorOption !== colorByCluster) {
            const fillValues = cluster_data.map(d => d.fill);
            const minFill = Math.min(...fillValues);
            const maxFill = Math.max(...fillValues);
            const tickStep = (maxFill - minFill) / 3;
            const ticks = Array.from({ length: 4 }, (_, i) => minFill + i * tickStep);

            layout.coloraxis.colorbar.tickvals = ticks;
            layout.coloraxis.colorbar.ticktext = ticks.map(t => t.toFixed(1));
        }

        // Update the plot
        Plotly.react('plotContainer_umap', traces, layout);
    }

    // Initial trace and layout
    const initialTraces = createTraces(colorByCluster, true);

    const layout = {
        title: 'Cluster Plot with Adjusted Labels',
        xaxis: {
            visible: false,
            showgrid: false,
        },
        yaxis: {
            visible: false,
            showgrid: false,
        },
        hovermode: 'closest',
        showlegend: true,
        plot_bgcolor: '#FFFFFF',
        autosize: false,
        width: 800,
        height: 600,
        coloraxis: {
            colorscale: 'RdBu', // Ensure consistent color scale
            colorbar: {
                thickness: 20,
                len: 0.5,
                title: {
                    text: 'Gradient',
                    side: 'right'
                },
                tickvals: [0, 10, 20, 30], // Example values; these will be dynamically set by createTraces
                ticktext: ['0', '10', '20', '30'] // Example text; adjust as per your data
            }
        }
    };



    // Plotly plotting
    Plotly.newPlot('plotContainer_umap', initialTraces, layout);

    // Event listeners to switch between coloring options
    document.getElementById("colorByCluster").addEventListener("click", function() {
        document.getElementById("colorByCluster").classList.add("active");
        document.getElementById("colorByGradient").classList.remove("active");
        updatePlot();
    });

    document.getElementById("colorByGradient").addEventListener("click", function() {
        document.getElementById("colorByCluster").classList.remove("active");
        document.getElementById("colorByGradient").classList.add("active");
        updatePlot();
    });

    // Event listeners to show/hide labels
    document.getElementById("show").addEventListener("click", function() {
        document.getElementById("show").classList.add("active");
        document.getElementById("hide").classList.remove("active");
        updatePlot();
    });

    document.getElementById("hide").addEventListener("click", function() {
        document.getElementById("show").classList.remove("active");
        document.getElementById("hide").classList.add("active");
        updatePlot();
    });

});
</script>
{% endif %}

{% if Plot_evaluation_json.2 %}
<script>
  var listdata = {{ listplot_data|safe }};
  const data = {
      'Class A (Rhodopsin)': {
          'Aminergic receptors': {
              '5-Hydroxytryptamine receptors': [
                  { '5-HT<sub>1A</sub> receptor': ['Yes', 1.0] },
                  { '5-HT<sub>1B</sub> receptor': ['no', 2.0] },
                  { '5-HT<sub>1D</sub> receptor': ['no', 3.0] }
              ]
          },
          'Peptide receptors': {
              'Formylpeptide receptors': [
                  { 'FPR2/ALX': ['yes', 4.0] }
              ]
          },
          'Protein receptors': {
              'Chemokine receptors': [
                  { 'CXCR5': ['yes', 4.0] },
                  { 'ACKR3': ['yes', 4.0] }
              ],
              'Glycoprotein hormone receptors': [
                  { 'FSH receptor': ['yes', 4.0] }
              ]
          },
          'Lipid receptors': {
              'Lysophospholipid (LPA) receptors': [
                  { 'LPA<sub>5</sub> receptor': ['yes', 4.0] }
              ]
          },
          'Steroid receptors': {
              'Bile acid receptors': [
                  { 'GPBA receptor': ['yes', 4.0] }
              ]
          },
          'Olfactory receptors': {
              'Olfactory': [
                  { 'Olfactory receptor 51L1': ['yes', 4.0] }
              ]
          },
          'Orphan receptors': {
              'Class A orphans': [
                  { '<i>GPR15</i>': ['yes', 4.0] }
              ]
          }
      },
      'Class B1 (Secretin)': {
          'Peptide receptors': {
              'Glucagon receptor family': [
                  { 'glucagon receptor': ['yes', 4.0] }
              ]
          }
      },
      'Class B2 (Adhesion)': {
          'Adhesion receptors': [
              { 'ADGRG5': ['yes', 4.0] }
          ]
      },
      'Class T (Taste 2)': {
          'Sensory receptors': {
              'Taste 2 receptors': [
                  { '<i>TAS2R60</i>': ['yes', 4.0] }
              ]
          }
      }
  };
  renderDataVisualization(data, 'ListPlot');
</script>
{% endif %}

{% if Plot_evaluation_json.3 %}
<script>
  var heatmap = {{ heatmap_data|safe }};
  var element_id = "heatmap1"; // Unique ID for the SVG element
  var legend_label = "Value Intensity"; // Label for the legend
  simple_heatmap(heatmap, 'heatmapPlot', element_id, legend_label);
</script>
{% endif %}

{% endblock %}
