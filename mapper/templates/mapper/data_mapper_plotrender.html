{% extends "home/base.html" %}
{% load static %}
{% load humanize %}
{% block addon_css %}
<link rel="stylesheet" href="{% static 'home/css/nv.d3.min.css' %}" type="text/css" />
<link rel="stylesheet" href="{% static 'home/css/nvd3-update.css' %}" type="text/css" />
<link href="{% static 'home/css/bootstrap-responsive.css' %}" rel="stylesheet" media="screen">
<link rel="stylesheet" href="{% static 'home/css/Spectrum_1_8_1.css' %}" type="text/css" />


{% endblock %}

{% block content %}
<style>
    .gprot_orange {
      color: orange;
    }

    .gprot_blue {
      color: blue;
    }

    .gprot_red {
      color: red;
    }

    .gprot_black {
      color: black;
    }

    .gprot_green {
      color: forestgreen;
    }
    .graydiv {
        height: 20px;
        width: 350px;
        background: linear-gradient(to right, white 0%, black 100%)
    }
    .svg-container {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #plotContainer_umap {
        width: 1600px; /* Set width */
        height: 1200px; /* Set height */
        margin: auto; /* Center the plot */
    }
    .hidden {
        display: none;
    }

    .color-picker {
      display: flex;
      align-items: center;
    }
    .color-box {
      width: 20px;
      height: 20px;
      margin-right: 10px;
      border: 1px solid #000;
    }

  /* Style adjustments for better visibility */
  .custom-control-label {
      cursor: pointer;
    }
    .dropdown-menu-listplot {
      background-color: rgba(255, 255, 255, 1); /* Slightly transparent white background */
      max-height: 300px; /* Maximum height of the dropdown menu */
      overflow-y: auto; /* Enable vertical scrolling if needed */
      left: 25%; /* Ensures the dropdown opens to the right */
      top: 50%; /* Adjust this value to align the dropdown vertically in the middle */
      transform: translateY(-50%); /* Center align vertically */
      margin-left: 10px; /* Add some space between the button and the dropdown */
    }
    .dropdown-menu-right-middle {
      left: 75%;
      top: 50%;
      transform: translateY(-50%);
      margin-left: 10px; /* Add some space between the button and the dropdown */
      width: 100px !important;
    }
    .btn-custom-blue {
        background-color: #5bc0de; /* Light blue color */
        border-color: #5bc0de;
        color: #fff; /* Darker text for better contrast */
    }

    .btn-custom-blue:hover {
        background-color: #31b0d5; /* Lighter sky blue for hover effect */
        border-color: #31b0d5;
    }

</style>
<div class='col-md-12'>
  <br />
  <h3 style='text-align:center;'>Data Mapper Plots</h3>
  <br \>
</div>

<!-- ### Create the panel tabs ### -->
<ul class="nav nav-tabs">
  {% if Plot_evaluation_json.0 %}
    <li class="{% if first_active_tab == '#tab1' %}active{% endif %}">
      <a href="#tab1" data-toggle="tab">Tree</a>
    </li>
  {% endif %}
  {% if Plot_evaluation_json.1 %}
    <li class="{% if first_active_tab == '#tab2' %}active{% endif %}">
      <a href="#tab2" data-toggle="tab">Cluster</a>
    </li>
  {% endif %}
  {% if Plot_evaluation_json.2 %}
    <li class="{% if first_active_tab == '#tab3' %}active{% endif %}">
      <a href="#tab3" data-toggle="tab">List</a>
    </li>
  {% endif %}
  {% if Plot_evaluation_json.3 %}
    <li class="{% if first_active_tab == '#tab4' %}active{% endif %}">
      <a href="#tab4" data-toggle="tab">Heatmap</a>
    </li>
  {% endif %}
  {% if Plot_evaluation_json.4 %}
  <li class="{% if first_active_tab == '#tab5' %}active{% endif %}">
    <a href="#tab5" data-toggle="tab">Dart</a>
  </li>
  {% endif %}
</ul>

<!-- ## Tab content ## -->
<div class="tab-content">
  <!-- ####################### -->
  <!-- ##   Tab 1 - Tree    ## -->
  <!-- ####################### -->
  {% if Plot_evaluation_json.0 %}
  <div id="tab1" class="tab-pane fade {% if first_active_tab == '#tab1' %}in active{% endif %}">
    <div style="padding-top: 10px; font-size: 11px; white-space: nowrap;">
      <div>
        <div style="padding-top: 5px;">
          Receptor names:
            <div class="btn-group" role="group" id="gtp_plus">
                <button id="UniProtNames" class="btn btn-info active">Gene</button>
                <button id="IUPHARNames" class="btn btn-info">Protein</button>
            </div>
        </div>
        <!-- ################### -->
        <!-- # Styling buttons # -->
        <!-- ################### -->
        <div class="col-md-12" style="margin-top: 20px;margin-bottom: 30px;">
          <div class="col-md-2">
          <div class="dropdown" style="width: 500px !important;">
            <button class="btn btn-primary dropdown-toggle" type="button" id="Styling_Menu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Color styling
            </button>
            <div class="dropdown-menu dropdown-menu-listplot" aria-labelledby="Styling_Menu">
              <!-- Color complexity Dropdown -->
              <div class="col-md-12" style="width:400px;margin-top: 20px;margin-bottom: 20px;">
                  <div class="col-md-6" style="width:180px">
                    <select id="Tree_color_styling" class="form-select" style="height: 30px;width: 150px;font-size: 14px;" aria-label="Default select example" onchange="Tree_UpdateColorcomplexity()">
                    </select>
                  </div>
                  <div class="col-md-6" style="width:180px">
                    <select id="Tree_color_styling_complexity" class="form-select" style="height: 30px;width: 150px;font-size: 14px;" aria-label="Default select example" onchange="Tree_UpdateColorpickers()">
                      <option value="One" selected>One color</option>
                      <option value="Two">Two colors</option>
                      <option value="Three">Three colors</option>
                    </select>
                  </div>
                </div>

                <!-- Color Selector Dropdown -->
                <div class="col-md-12" style="height: 15px;width: 400px;margin-bottom: 30px;">
                    <div class="col-md-6 text-center" id="Tree_Color_min_container" style="display:None;width: 180px">
                      <input type="text" id="Tree_colorPicker_min" />
                    </div>
                  <!-- Color Selector Dropdown -->
                    <div class="col-md-6 text-center" id="Tree_Color_max_container" style="width:180px">
                      <input type="text" id="Tree_colorPicker_max"/>
                    </div>
                </div>
                
                <!-- Render button -->
                <div class="col-md-12" style="width:400px;margin-top: 15px;margin-bottom: 15px;">
                  <!-- Render Plot Button -->
                  <div class="text-center" style="margin-bottom: 15px;">
                    <button id="RenderTree_ColorStyling" type="button" class="btn btn-primary" style="font-size: 18px;">Render Heatmap</button>
                  </div>
                </div>   
              </div>
            </div>
        </div>

         <!-- ############### -->
        <!-- ### Label Styling ###  -->
         <!-- ############### -->
         <div class="col-md-2" style="margin-left: 10px;margin-right: -10px;">
          <div class="dropdown" style="width: 400px !important;">
            <button class="btn btn-primary dropdown-toggle" type="button" id="Styling_Menu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Label Styling
            </button>
            <div class="dropdown-menu dropdown-menu-listplot" aria-labelledby="Styling_Menu">
              <!-- Layer Selector Dropdown -->
              <div class="col-md-12" style="width:300px;margin-top: 20px;margin-bottom: 20px;">
                <div class="col-md-6" style="padding-left:0;padding-right:0;">
                  <select id="Tree_Styling_layerSelector" class="form-select" style="height: 30px;width: 120px;font-size: 14px;" aria-label="Default select example" onchange="Tree_updateLabelStyling()">
                    <option value="class" selected>Class</option>
                    <option value="ligandtype">Ligand type</option>
                    <option value="receptorfamily">Receptor family</option>
                    <option value="receptor">Receptor</option>
                  </select>
                </div>
              </div>
              <!-- Font Size Slider -->
              <div class="col-md-12" style="text-align: center;">
                <label for="fontSizeSliderValue" id="Tree_fontSizeSliderLabel" class="form-label">Font Size: 16px</label>
              </div>
              <div class="col-md-12" style="margin-bottom: 30px;">
                <input type="range" class="form-range" min="8" max="20" value="16" id="Tree_fontSizeSlider">
              </div>
              <!-- Render Plot Button -->
              <div class="col-md-12" style="text-align: center;">
              <div class="text-center" style="margin-bottom: 20px;">
                <button id="renderTreePlot_label" type="button" class="btn btn-primary" style="font-size: 18px;">Render Tree</button>
              </div>
            </div>
            </div>
          </div>
         </div>
        <!-- ################ -->
        <!-- # Data styling # -->
        <!-- ################ -->
        
        <div class="col-md-2" style="margin-left: 10px;margin-right: -10px;">
          <div class="dropdown" style="width: 400px !important;">
            <button class="btn btn-primary dropdown-toggle" type="button" id="Styling_Menu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Data Styling
            </button>
            <div class="dropdown-menu dropdown-menu-listplot" aria-labelledby="Styling_Menu">
              
              <!-- Circle Size Slider -->
              <div class="col-md-12" style="text-align: center;">
                <label for="Tree_circleSizeSlider" id="Tree_circleSizeSliderLabel" class="form-label">Circle Size</label>
              </div>
              <div class="col-md-12" style="margin-bottom: 10px;">
                <input type="range" class="form-range" min="1" max="6" value="1" id="Tree_circleSizeSlider">
                <div style="text-align: center;">
                  <span id="Tree_circleSizeValue">1</span>
                </div>
              </div>
              
              <!-- Space Size Slider -->
              <div class="col-md-12" style="text-align: center;">
                <label for="Tree_circleSpacerSlider" id="Tree_circleSpacerSliderLabel" class="form-label">Circle Spacer</label>
              </div>
              <div class="col-md-12" style="margin-bottom: 10px;">
                <input type="range" class="form-range" min="0" max="2" value="0" id="Tree_circleSpacerSlider">
                <div style="text-align: center;">
                  <span id="Tree_circleSpacerValue">0</span>
                </div>
              </div>
              
              <!-- Render Plot Button -->
              <div class="col-md-12" style="text-align: center;">
                <div class="text-center" style="margin-bottom: 20px;">
                  <button id="renderTreePlot_Circles" type="button" class="btn btn-primary" style="font-size: 18px;">Render Tree</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- # Download button # -->
        <div class="col-md-3"></div>
        <div class="col-md-3">
          <div class="text-center">
            <div class="dropdown">
              <button type="button" class="btn btn-primary dropdown-toggle" style="font-size: 14px;" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <span class="glyphicon glyphicon-download" style="vertical-align: top;line-height: 1.3"></span> Download <span class="caret"></span>
              </button>
              <div class="dropdown-menu dropdown-menu-right-middle">
                <li><a class="dropdown-item" href="javascript:saveSvg(document.getElementById('tree_plot_svg'), 'Tree.svg');">SVG</a></li>
                <li><a class="dropdown-item" href="javascript:saveSvgAsPng(document.getElementById('tree_plot_svg'), 'Tree.png');">PNG</a></li>
                <li><a class="dropdown-item" href="javascript:saveSvgAsJpg(document.getElementById('tree_plot_svg'), 'Tree.jpg');">JPG</a></li>
                <li><a class="dropdown-item" href="javascript:saveSvgAsTiff(document.getElementById('tree_plot_svg'), 'Tree.tiff');">TIFF</a></li>
              </div>
            </div>
          </div>
        </div>

        </div>
        <!-- ############# -->
        <!-- # TREE plot # -->
        <!-- ############# -->
        
        
         <!-- Legend bars -->
        <div class="col-md-12" id="legend_bars">
          <svg width="800" height="75"></svg>
        </div>
        <!-- Tree -->
        <div class="col-md-12" style="margin-top: 0px;margin-bottom: 30px;">
            <div id="tree_plot" class="text-center"></div>
        </div>
        
      </div>
    </div>
  </div>
  {% endif %}
  <!-- ####################### -->
  <!-- ## Tab 2 - Cluster   ## -->
  <!-- ####################### -->
  {% if Plot_evaluation_json.1 %}
    <div id="tab2" class="tab-pane fade {% if first_active_tab == '#tab2' %}in active{% endif %}">
      <div style="padding-top: 10px; font-size: 14px; white-space: nowrap;">
        <!-- <div class="col-md-12" style="padding-top: 20px;">
          <div class="col-md-4">
          Clustering by:
            <div class="btn-group" role="group" id="gtp_plus">
                <button id="datasetSeq" class="btn btn-info active">Sequence similiarity</button>
                <button id="datasetStructure" class="btn btn-info">Structure similiarity</button>
            </div>
          </div>
          <div class="col-md-6"></div>
          <div class="col-md-2">
            <div class="text-center">
                <div class="dropdown">
                    <button type="button" class="btn btn-primary dropdown-toggle" style="font-size: 14px;" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <span class="glyphicon glyphicon-download" style="vertical-align: top;line-height: 1.3"></span> Download <span class="caret"></span>
                    </button>
                    <div class="dropdown-menu dropdown-menu-right-middle">
                        <li><a class="dropdown-item" href="javascript:downloadPlot('svg');">SVG</a></li>
                        <li><a class="dropdown-item" href="javascript:downloadPlot('png');">PNG</a></li>
                        <li><a class="dropdown-item" href="javascript:downloadPlot('jpg');">JPG</a></li>
                        <li><a class="dropdown-item" href="javascript:downloadPlot('tiff');">TIFF</a></li>
                    </div>
                </div>
            </div>
        </div>
        </div> -->
        <div class="col-md-12" style="padding-top: 20px;">
          <div class="col-md-1">Color by:</div>
            <div class="col-md-7">
              <div class="btn-group" role="group" id="colorOptions">
                <button id="colorByCluster" class="btn btn-info active">Cluster</button>
                <button id="colorByGradient" class="btn btn-info">Gradient</button>
                <button id="colorByClass" class="btn btn-info">Class</button>
                <button id="colorByLigandType" class="btn btn-info">Ligand Type</button>
                <button id="colorByReceptorFamily" class="btn btn-info">Receptor Family</button>
              </div>
            </div>
            <div class="col-md-1"></div>
            <div class="col-md-2">
              <div class="text-center">
                <div class="dropdown">
                    <button type="button" class="btn btn-primary dropdown-toggle" style="font-size: 14px;" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <span class="glyphicon glyphicon-download" style="vertical-align: top;line-height: 1.3"></span> Download <span class="caret"></span>
                    </button>
                    <div class="dropdown-menu dropdown-menu-right-middle">
                        <li><a class="dropdown-item" href="javascript:downloadPlot('svg');">SVG</a></li>
                        <li><a class="dropdown-item" href="javascript:downloadPlot('png');">PNG</a></li>
                        <li><a class="dropdown-item" href="javascript:downloadPlot('jpg');">JPG</a></li>
                        <li><a class="dropdown-item" href="javascript:downloadPlot('tiff');">TIFF</a></li>
                    </div>
                </div>
            </div>
            </div>
        </div>
        <div class="col-md-12" style="padding-top: 20px;">
          <div class="col-md-1">Plot labels:</div>
          <div class="col-md-5">
            <div class="btn-group" role="group" id="gtp_plus">
                <button id="show" class="btn btn-info">Show</button>
                <button id="hide" class="btn btn-info active">Hide</button>
                <button id="rerenderLabels" type="button" class="btn btn-custom-blue">Rerender Labels</button>
            </div>
          </div>
          <div class="col-md-6"></div>
        </div>
        <div class="col-md-12" style="padding-top: 0x;padding-bottom: 20px">
            <div class="col-md-1" style="margin-top: 36px;margin-right: 20px;text-align: left;margin-left: -15px">Styling options: </div>
              <div class="col-md-2" style="margin-left: 10px; margin-right: -10px;margin-top: 30px;" >
                  <div class="dropdown" style="width: 400px !important;">
                      <button class="btn btn-primary dropdown-toggle" type="button" id="clusteringMenu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                          Clustering Options
                      </button>
                      <div class="dropdown-menu" aria-labelledby="clusteringMenu">
                          <!-- Number of Clusters Slider -->
                          <div class="col-md-12" style="text-align: center;">
                              <label for="clusterSlider" id="clusterSliderLabel" class="form-label">Number of Clusters</label>
                          </div>
                          <div class="col-md-12" style="margin-bottom: 10px;">
                              <input type="range" class="form-range" min="1" max="20" value="5" id="clusterSlider">
                              <div style="text-align: center;">
                                  <span id="clusterSliderValue">5</span>
                              </div>
                          </div>
  
                          <!-- Render Plot Button -->
                          <div class="col-md-12" style="text-align: center;">
                              <div class="text-center" style="margin-bottom: 20px;">
                                  <button id="renderClusterPlot" type="button" class="btn btn-primary" style="font-size: 18px;">Render Clustering</button>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
      </div>

      <!-- Container for the Plotly Plot -->
      <div id="plotContainer_umap" style="width: 1600px; height: 1200px;"></div>
    </div>
  </div>
  {% endif %}
  <!-- ####################### -->
  <!-- ##   Tab 3 - List    ## -->
  <!-- ####################### -->
  {% if Plot_evaluation_json.2 %}
    <div id="tab3" class="tab-pane fade {% if first_active_tab == '#tab3' %}in active{% endif %}">
      <div style="padding-top: 10px; font-size: 11px; white-space: nowrap;"></div>
      <!-- ############ -->
      <!-- ## Layout ## -->
      <!-- ############ -->
      <div class="col-md-8" style="margin-top: 30px;">
        <div class="col-md-2" style="margin-left: 10px;margin-right: -40px;">
          <div class="dropdown">
            <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Layout
            </button>
            <div class="dropdown-menu dropdown-menu-listplot" style="margin-left: 50px;" aria-labelledby="dropdownMenuButton">
              <div class="col-md-12" style="width:400px;margin-top: 20px;margin-bottom: 20px;text-align: center;">
                <div class="col-md-6" style="padding-left:0;padding-right:0;">
                  <select id="Layout_Column_Selector" class="form-select" style="height: 30px;width: 180px;font-size: 14px;" aria-label="Default select example">
                  <option value="1">1 column</option>
                  <option value="2" selected>2 columns</option>
                  <option value="3">3 columns</option>
                  <option value="4">4 columns</option>
                </select>
                </div>
                <div class="col-md-6" style="padding-left:0;padding-right:0;">
                    <select id="Layout_Column_Breaker" class="form-select" style="height: 30px;width: 160px;font-size: 14px;" aria-label="Default select example">
                    <option value="Layer1">Class</option>
                    <option value="Layer2">Ligand type</option>
                    <option value="Layer3">receptor family</option>
                    <option value="Layer4">receptor</option>
                    <option value="Custom" selected>Custom</option>
                  </select>
                </div>
              </div>
              <div class="col-md-12" style="text-align: center;">
                <label>Max label number per columns</label>
              </div>
              <div class="col-md-12" style="margin-bottom: 20px;text-align: center;">
                <select id="Layout_Max_Label" class="form-select" style="height: 30px;width: 180px;font-size: 14px;" aria-label="Default select example">
                  <option selected>Auto</option>
                  <option value="Custom">Custom</option>
                </select>
              <input type="number" id="Layout_Max_Label_input" name="Layout_Max_Label_input" step="1" min="1" style="height: 30px;width: 60px;font-size: 14px;">
              </div>
              <!-- <div class="col-md-12"  style="padding-top: 10px;text-align: center;font-size: 14px;margin-bottom: 20px;">
                <div class="custom-checkbox">
                  <input type="checkbox" class="custom-control-input" id="toggle-indentation">
                  <label class="custom-control-label" for="toggle-indentation">Level indentation</label>
                </div>
              </div> -->
              <!-- Render Plot Button -->
              <div class="text-center"  style="margin-bottom: 20px;margin-top: 30px;">
                <button id="RenderLayoutButton_Layout" type="button" class="btn btn-primary" style="font-size: 18px;">Render List</button>
              </div>
            </div>
          </div>
        </div>
        <!-- ################## -->
        <!-- ## Levels Button ## -->
         <!-- ################## -->
        <div class="col-md-2" style="margin-left: 10px;margin-right: -40px;">
          <div class="dropdown" style="width: 100px !important;">
            <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Levels
            </button>
            <div class="dropdown-menu dropdown-menu-listplot" style="left: 60%"  aria-labelledby="dropdownMenuButton">
              <div class="col-md-12" style="text-align: left;font-size: 16px;">Set visible levels
                <div class="col-md-12" style="padding-top: 10px;">
                  <div class="custom-checkbox">
                    <input type="checkbox" class="custom-control-input" id="toggle-layer-1" checked>
                    <label class="custom-control-label" for="toggle-layer-1" style="margin-left: 5px;font-size: 16px;">Display class</label>
                  </div>
                </div>
                <div class="col-md-12"  style="padding-top: 10px;">
                  <div class="custom-checkbox">
                    <input type="checkbox" class="custom-control-input" id="toggle-layer-2" checked>
                    <label class="custom-control-label" for="toggle-layer-2">Display ligand type</label>
                  </div>
                </div>
                <div class="col-md-12"  style="padding-top: 10px;">
                  <div class="custom-checkbox">
                    <input type="checkbox" class="custom-control-input" id="toggle-layer-3" checked>
                    <label class="custom-control-label" for="toggle-layer-3">Display receptor family</label>
                  </div>
                </div>
                <!-- <div class="col-md-12"  style="padding-top: 10px;">
                  <div class="custom-checkbox">
                    <input type="checkbox" class="custom-control-input" id="toggle-layer-4" checked>
                    <label class="custom-control-label" for="toggle-layer-4">Display receptor</label>
                  </div>
                </div> -->
              </div>
            </div>
          </div>
        </div>

        <!-- ############### -->
        <!-- ### Label Styling ###  -->
         <!-- ############### -->
        <div class="col-md-2" style="margin-left: 10px;margin-right: -10px;">
          <div class="dropdown" style="width: 400px !important;">
            <button class="btn btn-primary dropdown-toggle" type="button" id="Styling_Menu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Label Styling
            </button>
            <div class="dropdown-menu dropdown-menu-listplot" aria-labelledby="Styling_Menu">
              <!-- Layer Selector Dropdown -->
              <div class="col-md-12" style="width:300px;margin-top: 20px;margin-bottom: 20px;">
                <div class="col-md-6" style="padding-left:0;padding-right:0;">
                  <select id="Styling_layerSelector" class="form-select" style="height: 30px;width: 120px;font-size: 14px;" aria-label="Default select example" onchange="updateMax()">
                    <option value="Layer1" selected>Class</option>
                    <option value="Layer2">Ligand type</option>
                    <option value="Layer3">Receptor family</option>
                    <option value="Layer4">Receptor</option>
                  </select>
                </div>

                <!-- Color Selector Dropdown -->
                <div class="col-md-6">
                  <div class="color-picker">
                    <input type="text" id="colorPicker_LabelStyling"/>
                  </div>
                </div>
              </div>
              <div class="col-md-12" style="width:300px;margin-top: 20px;margin-bottom: 20px;">
                <!-- Bold Checkbox -->
                <div class="form-check col-md-4" style="padding-left:0;padding-right:0;">
                  <input class="form-check-input" type="checkbox" value="" id="boldCheckbox">
                  <label class="form-check-label" for="boldCheckbox">
                    Bold
                  </label>
                </div>

                <!-- Italic Checkbox -->
                <div class="form-check col-md-4" style="padding-left:0;padding-right:0;">
                  <input class="form-check-input" type="checkbox" value="" id="italicCheckbox">
                  <label class="form-check-label" for="italicCheckbox">
                    Italic
                  </label>
                </div>

                <!-- Underline Checkbox -->
                <div class="form-check col-md-4" style="padding-left:0;padding-right:0;">
                  <input class="form-check-input" type="checkbox" value="" id="underlineCheckbox">
                  <label class="form-check-label" for="underlineCheckbox">
                    Underline
                  </label>
                </div>
              </div>
              <!-- Font Size Slider -->
              <div class="col-md-12" style="text-align: center;">
                <label for="fontSizeSliderValue" id="fontSizeSliderLabel" class="form-label">Font Size: 16px</label>
              </div>
              <div class="col-md-12" style="margin-bottom: 30px;">
                <input type="range" class="form-range" min="8" max="32" id="fontSizeSlider">
              </div>
              <!-- Render Plot Button -->
              <div class="text-center" style="margin-bottom: 20px;">
                <button id="renderPlotButton" type="button" class="btn btn-primary" style="font-size: 18px;">Render List</button>
              </div>
            </div>
          </div>
        </div>
        <!-- ##################### -->
        <!-- ##  Data styling   ## -->
        <!-- ##################### -->
        <div class="col-md-2" style="margin-left: 20px;margin-right: -20px;">
          <div class="dropdown" style="width: 450px !important;">
            <button class="btn btn-primary dropdown-toggle" type="button" id="Data_Styling_Menu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Data Styling
            </button>
            <div class="dropdown-menu dropdown-menu-listplot" style="margin-left: -8px;" aria-labelledby="Data_Styling_Menu">
              <!-- Data Selector Dropdown -->
              <div class="col-md-12" style="width:400px;margin-top: 20px;margin-bottom: 10px;">
                <div class="col-md-6" style="padding-left:0;padding-right:0;">
                  <select id="Data_Styling_Selector" class="form-select" style="height: 35px;width: 130px;font-size: 14px;" onchange="updateColorComplexityDropdown()">
                    <option value="Select Data" selected>Select Data</option>
                  </select>
                </div>
                <div class="col-md-6" style="padding-left:0;padding-right:0;margin-left: -20px;">
                </div>
              </div>
              <div class="col-md-12" style="width:400px;margin-top: 10px;margin-bottom: 10px;">
                <div class="col-md-6" style="padding-left:0;padding-right:0;">
                  <select id="ColorComplexityDropdown" style="display: none;height: 35px;width: 130px;font-size: 14px;" onchange="updateColorDropdowns()">
                    <option value="One" selected>One Color</option>
                    <option value="Two">Two Colors</option>
                  </select>
                </div>
                <div class="col-md-6" style="padding-left:0;padding-right:0;margin-left: -20px;">
                  <div class="color-picker" id="OneColor_DataStyling_container" style="display: none;height: 35px;width: 130px;font-size: 14px;">
                    <input type="text" id="OneColor_DataStyling"/>
                  </div>
                </div>
                <div class="col-md-6" style="padding-left:0;padding-right:0;">
                  <div class="col-md-3" style="padding-left:0;padding-right:0px;margin-left: -20px;margin-right: 20px;">
                    <div class="color-picker" id="TwoColor_DataStyling_One_container" style="display: none;height: 35px;width: 130px;font-size: 14px;">
                      <input type="text" id="TwoColor_DataStyling_one"/>
                    </div>
                  </div>
                  <div class="col-md-3" style="padding-left:0;padding-right:0;margin-left: 20px;">
                    <div class="color-picker" id="TwoColor_DataStyling_Two_container" style="display: none;height: 35px;width: 130px;font-size: 14px;">
                      <input type="text" id="TwoColor_DataStyling_two"/>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-12" style="width:400px;margin-top: 15px;margin-bottom: 15px;">
                <!-- Render Plot Button -->
                <div class="text-center" style="margin-bottom: 15px;">
                  <button id="DataStyling_renderPlotButton" type="button" class="btn btn-primary" style="font-size: 18px;" disabled>Render List</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ##################### -->
        <!-- ## Download button ## -->
        <!-- ##################### -->
        </div>
        <div class="col-md-1" style="margin-top: 30px;"></div>
        <div class="col-md-3" style="margin-top: 30px;">
        <div class="col-md-3">
          <div class="text-center">
            <div class="dropdown">
              <button type="button" class="btn btn-primary dropdown-toggle" style="font-size: 14px;" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <span class="glyphicon glyphicon-download" style="vertical-align: top;line-height: 1.3"></span> Download <span class="caret"></span>
              </button>
              <div class="dropdown-menu dropdown-menu-right-middle">
                <li><a class="dropdown-item" href="javascript:saveSvg(document.getElementById('ListPlot_visualization'), 'DataVisualization.svg');">SVG</a></li>
                <li><a class="dropdown-item" href="javascript:saveSvgAsPng(document.getElementById('ListPlot_visualization'), 'DataVisualization.png');">PNG</a></li>
                <li><a class="dropdown-item" href="javascript:saveSvgAsJpg(document.getElementById('ListPlot_visualization'), 'DataVisualization.jpg');">JPG</a></li>
                <li><a class="dropdown-item" href="javascript:saveSvgAsTiff(document.getElementById('ListPlot_visualization'), 'DataVisualization.tiff');">TIFF</a></li>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Receptor label switch -->
      <div class="col-md-12" style="margin-top: 20px;">
        <div>
          Receptor names:
            <div class="btn-group" role="group" id="gtp_plus">
                <button id="List_UniProtNames" class="btn btn-info">UniProt</button>
                <button id="List_IUPHARNames" class="btn btn-info active">IUPHAR</button>
            </div>
        </div>
      </div>
      <div id="ListPlot" class="text-left" style="margin-top: 120px;"></div>
    </div>

  {% endif %}
  <!-- ##################### -->
  <!-- ## Tab 4 - Heatmap ## -->
  <!-- ##################### -->
  {% if Plot_evaluation_json.3 %}
    <div id="tab4" class="tab-pane fade {% if first_active_tab == '#tab4' %}in active{% endif %}">
      <div style="padding-top: 10px; font-size: 11px; white-space: nowrap;"></div>
      <!-- Receptor label switch -->
      <div class="col-md-12" style="margin-top: 20px;">
        <div>
          Receptor names:
            <div class="btn-group" role="group" id="gtp_plus">
                <button id="Heatmap_UniProtNames" class="btn btn-info active">UniProt</button>
                <button id="Heatmap_IUPHARNames" class="btn btn-info">IUPHAR</button>
            </div>
        </div>
      </div>
      <div class="col-md-12" style="margin-top: 20px;margin-bottom: 30px;">
        <div class="col-md-2">
        <div class="dropdown" style="width: 500px !important;">
          <button class="btn btn-primary dropdown-toggle" type="button" id="Styling_Menu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Color styling
          </button>
          <div class="dropdown-menu dropdown-menu-listplot" aria-labelledby="Styling_Menu">
            <!-- Color complexity Dropdown -->
            <div class="col-md-12" style="width:400px;margin-top: 20px;margin-bottom: 20px;">
              <div class="col-md-6" style="width:150px;margin-right: 20px;">
                <select id="Heatmap_color_styling" class="form-select" style="height: 30px;width: 150px;font-size: 14px;" aria-label="Default select example" onchange="UpdateColorPickers()">
                  <option value="One" selected>One color</option>
                  <option value="Two">Two colors</option>
                  <option value="Three">Three colors</option>
                </select>
              </div>
        
              <!-- Color Selector Dropdown -->
              <div class="col-md-6" style="height: 15px;width: 200px;">
                  <div class="col-md-3" id="Heatmap_Color_min_container" style="display: none;width: 80px;margin-left: 0px;margin-right: 0px;">
                    <input type="text" id="Heatmap_colorPicker_min" />
                  </div>
                <!-- Color Selector Dropdown -->
                  <div class="col-md-3" id="Heatmap_Color_max_container" style="width: 80px;margin-left: 0px;margin-right: 0px;">
                    <input type="text" id="Heatmap_colorPicker_max"/>
                  </div>
              </div>
            </div>
            <!-- Set Colors Buttons -->
            <div class="text-center" style="margin-bottom: 15px;">
              <div class="col-md-12" style="margin-bottom: 5px;">
                <div class="col-md-6"><button id="GrayScale" type="button" class="btn btn-primary" style="width:150px;font-size: 14px;">Grey scale</button></div>
                <div class="col-md-6"><button id="GrayBlueScale" type="button" class="btn btn-primary" style="width:150px;font-size: 14px;">Grey-Blue scale</button></div>
              </div>
              <div class="col-md-12">
                <div class="col-md-6"><button id="RedBlueScale" type="button" class="btn btn-primary" style="width:150px;font-size: 14px; margin-right: 10px;">Red-Blue Scale</button></div>
                <div class="col-md-6"><button id="TealMagentaScale" type="button" class="btn btn-primary" style="width:150px;font-size: 14px; margin-right: 10px;">Teal-Magenta Scale</button></div>
              </div>
            </div>
            <!-- Render button -->
            <div class="col-md-12" style="width:400px;margin-top: 15px;margin-bottom: 15px;text-align: center;">
              <!-- Render Plot Button -->
              <div class="text-center" style="margin-bottom: 15px;">
                <button id="RenderHeatmap_colering" type="button" class="btn btn-primary" style="font-size: 18px;">Render Heatmap</button>
              </div>
            </div>    
          </div>
        </div>
      </div>
      <div class="col-md-2">
      <div class="dropdown" style="width: 400px !important;">
        <button class="btn btn-primary dropdown-toggle" type="button" id="Styling_Menu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          Label styling
        </button>
        <div class="dropdown-menu dropdown-menu-listplot" aria-labelledby="Styling_Menu">
          <!-- label styling Dropdown -->
          <div class="col-md-12" style="width:300px;margin-top: 20px;margin-bottom: 20px;">
            <div class="col-md-6" style="padding-left:0;padding-right:0;">Label orientation
              <select id="Heatmap_xlabel_styling" class="form-select" style="height: 30px;width: 120px;font-size: 14px;" aria-label="Default select example">
                <option value="0" >Horizontal</option>
                <!-- <option value="45">45 degrees</option> -->
                <option value="90" selected>Vertical</option>
              </select>
            </div>
            <div class="col-md-6" style="padding-left:0;padding-right:0;">Label Position
              <select id="Heatmap_xlabel_position" class="form-select" style="height: 30px;width: 120px;font-size: 14px;" aria-label="Default select example">
                <option value="Bottom" selected>Bottom</option>
                <option value="Top">Top</option>
              </select>
            </div>
          </div>
           <!-- Label Font Size Slider -->
           <div class="col-md-12" style="text-align: center;">
            <label for="Heatmap_fontSizeSliderValue" id="Heatmap_fontSizeSliderLabel" class="form-label">Label Font Size: 14px</label>
          </div>
          <div class="col-md-12" style="margin-bottom: 30px;">  
            <input type="range" class="form-range" min="10" max="16" id="Heatmap_fontSizeSlider" value="14">
          </div>

          <!-- Receptor Font Size Slider -->
          <div class="col-md-12" style="text-align: center;">
            <label for="Heatmap_receptor_fontSizeSliderValue" id="Heatmap_receptor_fontSizeSliderLabel" class="form-label">Receptor Font Size: 14px</label>
          </div>
          <div class="col-md-12" style="margin-bottom: 30px;">  
            <input type="range" class="form-range" min="8" max="15" id="Heatmap_receptor_fontSizeSlider" value="14">
          </div>

          <!-- Render button -->
          <div class="col-md-12" style="width:300px;margin-top: 15px;margin-bottom: 15px;">
            <!-- Render Plot Button -->
            <div class="text-center" style="margin-bottom: 15px;">
              <button id="RenderHeatmap_labels" type="button" class="btn btn-primary" style="font-size: 18px;">Render Heatmap</button>
            </div>
          </div>    
        </div>
        </div>
      </div>
      <div class="col-md-2">
        <div>
          <button id="Heatmap_data_labels" class="btn btn-success dropdown-toggle active">Data Labels</button>
      </div>
      </div>
      <div class="col-md-2">
        <div class="dropdown" style="width: 400px !important;">
          <button class="btn btn-primary dropdown-toggle" type="button" id="Heatmap_DataStyling_Menu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Data styling
          </button>
          <div class="dropdown-menu dropdown-menu-listplot" aria-labelledby="Heatmap_DataStyling_Menu">
            <!-- Layer Selector Dropdown -->
            <div class="col-md-12" style="width:300px;margin-top: 20px;margin-bottom: 20px;">
              <div class="col-md-6" style="padding-left:0;padding-right:0;">Data border
                <select id="Heatmap_Border_Styling" class="form-select" style="height: 30px;width: 120px;font-size: 14px;" aria-label="Default select example">
                  <option value="Yes" selected>Yes</option>
                  <option value="No" >No</option>
                </select>
              </div>
            </div>
            <!-- Data Font Size Slider -->
            <div class="col-md-12" style="text-align: center;">
              <label for="Heatmap_data_fontSizeSliderValue" id="Heatmap_data_fontSizeSliderLabel" class="form-label">Data Label Font Size: 12px</label>
            </div>
            <div class="col-md-12" style="margin-bottom: 30px;">  
              <input type="range" class="form-range" min="8" max="16" id="Heatmap_data_fontSizeSlider" value="12">
            </div>
            <!-- Render button -->
            <div class="col-md-12" style="width:300px;margin-top: 15px;margin-bottom: 15px;">
              <!-- Render Plot Button -->
              <div class="text-center" style="margin-bottom: 15px;">
                <button id="RenderHeatmap_DataStyling" type="button" class="btn btn-primary" style="font-size: 18px;">Render Heatmap</button>
              </div>
            </div>    
          </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="text-center">
            <div class="dropdown">
              <button type="button" class="btn btn-primary dropdown-toggle" style="font-size: 14px;" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <span class="glyphicon glyphicon-download" style="vertical-align: top;line-height: 1.3"></span> Download <span class="caret"></span>
              </button>
              <div class="dropdown-menu dropdown-menu-right-middle">
                <li><a class="dropdown-item" href="javascript:saveSvg(document.getElementById('Heatmap_plot'), 'Heatmap.svg');">SVG</a></li>
                <li><a class="dropdown-item" href="javascript:saveSvgAsPng(document.getElementById('Heatmap_plot'), 'Heatmap.png');">PNG</a></li>
                <li><a class="dropdown-item" href="javascript:saveSvgAsJpg(document.getElementById('Heatmap_plot'), 'Heatmap.jpg');">JPG</a></li>
                <li><a class="dropdown-item" href="javascript:saveSvgAsTiff(document.getElementById('Heatmap_plot'), 'Heatmap.tiff');">TIFF</a></li>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id="heatmapPlot" class="text-center" style="margin-left: -150px;"></div>
      </div>
  {% endif %}
  <!-- ##################### -->
  <!-- ##     Dart     ## -->
  <!-- ##################### -->
  {% if Plot_evaluation_json.4 %}
  <div id="tab5" class="tab-pane fade {% if first_active_tab == '#tab5' %}in active{% endif %}">
    <div style="padding-top: 10px; font-size: 11px; white-space: nowrap;">
      <div>
        <div style="padding-top: 5px;">
          Receptor names:
            <div class="btn-group" role="group" id="gtp_plus">
                <button id="Dart_UniProtNames" class="btn btn-info ">Gene</button>
                <button id="Dart_IUPHARNames" class="btn btn-info active">Protein</button>
            </div>
        </div>
        <div style="padding-top: 5px;">
          Circle Spacing:
          <button id="ToggleSpacing" class="btn btn-info active">On</button>
        </div>
        <div style="padding-top: 5px;">
          Receptor family:
          <button id="ToggleFamily" class="btn btn-info active">On</button>
        </div>
      </div>
      <!-- Dart -->
      <div class="col-md-12" style="margin-top: 0px;margin-bottom: 30px;">
          <div id="Dart_plot" class="text-center"></div>
      </div>
        
      </div>
    </div>
  {% endif %}
</div>

{% endblock %}

{% block addon_js %}
<script src="{% static 'home/js/d3.v5.min.js' %}"></script>
<script src="{% static 'home/js/nv.d3.min.js' %}"></script>
<!-- <script src="{% static 'home/js/d3v4.min.js' %}"></script> -->
<script src="{% static 'home/js/saveSvgAsPng.js' %}"></script>
<script src="{% static 'home/js/saveSvg.js' %}"></script>
<!-- <script src="{% static 'home/js/phylo_tree.js' %}"></script> -->
<script src="{% static 'home/js/datamapper.js' %}"></script>
<script src="{% static 'home/js/plotly_v1_58_5.js' %}"></script>
<script src="{% static 'home/js/popper.min.js' %}"></script>
<script src="{% static 'home/js/popper.min.js' %}"></script>
<script src="{% static 'home/js/spectrum_v1_8_1.js' %}"></script>
<script src="{% static 'home/js/ml.js' %}"></script>


<!-- ################## -->
<!-- ###    Tree    ### -->
<!-- ################## -->
{% if Plot_evaluation_json.0 %}

<script>
  $(document).ready(function() {
    // Function to initialize Spectrum color picker
    function initializeColorPicker(elementId,start_color) {
      $("#" + elementId).spectrum({
        color: start_color,
        showPalette: true,
        showInput: true,
        preferredFormat: "hex",
        palette: [
          ["#000", "#FF0000", "#00FF00", "#0000FF", "#FFFF00"],
          ["#FF00FF", "#00FFFF", "#FFFFFF", "#C0C0C0", "#808080"],
          ["#800000", "#808000", "#008000", "#800080", "#008080"],
          ["#000080"]
        ],
        change: function(color) {
          var selectedColor = color.toHexString();
        }
      });
    }
    // Initialize all color pickers
    initializeColorPicker("Tree_colorPicker_min","#FFFFFF");
    initializeColorPicker("Tree_colorPicker_max","#0000FF");
  });
</script>


<script type="text/javascript" charset="utf-8">

  // Set dropdown to keep open
  $('.dropdown-menu').on('click', function(event){
      event.stopPropagation();
    });

    // # Initialize data #
    tree_data = {{ tree | safe }};
    tree_options = {{ tree_options | safe }};
    Tree_circles = {{ circles|safe }};
    label_dict = {{ whole_dict|safe }};

    tree_data = update_tree_data(tree_data,tree_options.depth);

    console.log(tree_data);
    if (tree_options.depth == 4) {
      maxLeafNodeLenght = 4*parseInt(tree_options.fontSize.receptor);
    } else if (tree_options.depth == 3) {
      maxLeafNodeLenght = 4*parseInt(tree_options.fontSize.receptorfamily);
    }
    circle_size = 4;
    circle_spacer = circle_size*2+1;

    var Tree_circle_styling_dict = {
      "Outer2":"One",
      "Outer3":"Two",
      "Outer4":"Two",
      "Outer5":"Two",
      "Outer6":"Three",
    }

    conversion = {"Outer2":["#FFFFFF","#0000FF"],
                  "Outer3":["#FFFFFF","#FF0000"],
                  "Outer4":["#FFFFFF","#22c7b1"],
                  "Outer5":["#FFFFFF","#008000"],
                  "Outer6":["#ad1cd9","#FFA500"]};
    
    // # Change leaves buttons #
    $("#UniProtNames").click(function(){
        $("#UniProtNames").addClass("active");
        $("#IUPHARNames").removeClass("active");
        changeLeavesLabels("tree_plot", "UniProt", label_dict);
        DrawCircles('tree_plot', Tree_circles, maxLeafNodeLenght, conversion, true, true,Tree_circle_styling_dict,circle_spacer,circle_size);
    });
    $("#IUPHARNames").click(function() {
      $("#UniProtNames_bal").removeClass("active");
      $("#IUPHARNames_bal").addClass("active");
      changeLeavesLabels("tree_plot","IUPHAR", label_dict);
      DrawCircles('tree_plot', Tree_circles, maxLeafNodeLenght, conversion,true,true,Tree_circle_styling_dict,circle_spacer,circle_size);
    });
    // # Initialize tree plot #
    document.addEventListener("DOMContentLoaded", function() {
      draw_tree(tree_data, tree_options,circle_size);
      DrawCircles('tree_plot', Tree_circles, maxLeafNodeLenght, conversion, true, true,Tree_circle_styling_dict,circle_spacer,circle_size);
      createLegendBars('legend_bars', Tree_circles, conversion,Tree_circle_styling_dict);
    });
  
  // ## DATA styling buttons ##

  // # Color styling #
  // Populate dropdown
function populateKeyDropdown(circle_data) {
  var dropdown = document.getElementById("Tree_color_styling");
  // Clear existing options
  dropdown.innerHTML = "";
  // Initialize a set to track unique nested keys
  var uniqueKeys = new Set();
  // Collect unique nested keys from the data
  Object.values(circle_data).forEach(item => {
    Object.keys(item).forEach(key => {
      uniqueKeys.add(key); // Add key to set (automatically handles duplicates)
    });
  });
  // Add options to dropdown based on unique keys
  uniqueKeys.forEach(key => {
    var option = document.createElement("option");
    option.value = key; // Set the value of the option to the key
    option.textContent = key; // Display the key
    dropdown.appendChild(option);
  });
  // Set initial values based on the first dropdown option
  if (dropdown.options.length > 0) {
    dropdown.selectedIndex = 0;
    Tree_UpdateColorcomplexity();
  }
}
document.addEventListener("DOMContentLoaded", function() {
  populateKeyDropdown(Tree_circles);
});


function Tree_UpdateColorcomplexity() {
  const Tree_Color_styling = document.getElementById("Tree_color_styling");
  const Tree_Color_styling_complexity = document.getElementById("Tree_color_styling_complexity");
  
  // selected value
  const selectedValue = Tree_Color_styling.value;

  // Lookup the corresponding value in the dictionary
  const complexityValue = Tree_circle_styling_dict[selectedValue];

  // Update the second dropdown with the retrieved value
  if (complexityValue) {
          Tree_Color_styling_complexity.value = complexityValue;
      }
  Tree_UpdateColorpickers();

}

function Tree_UpdateColorpickers() {
// Color complexity
const Tree_Color_styling_complexity = document.querySelector('#Tree_color_styling_complexity');
const Tree_Color_styling_Data = document.getElementById("Tree_color_styling");

const Tree_Color_styling_complexity_value = Tree_Color_styling_complexity.value;
const Tree_Color_styling_Data_value = Tree_Color_styling_Data.value;

// Color picker location
const Tree_color_min = document.getElementById("Tree_colorPicker_min");
const Tree_Color_max = document.getElementById("Tree_colorPicker_max");

// Color picker containers 
const Tree_Color_min_container = document.getElementById("Tree_Color_min_container");
// const Heatmap_Color_max_container = document.getElementById("Heatmap_Color_max_container");
const Color_min = document.getElementById("Tree_colorPicker_min");
const Color_max = document.getElementById("Tree_colorPicker_max");

// // Get the selected layer value
// const Color_styling_value = Color_styling.value;

if (Tree_Color_styling_complexity_value == 'One') {
  Tree_Color_min_container.style.display = 'None';
} else if (Tree_Color_styling_complexity_value == 'Two'){
  Tree_Color_min_container.style.display = 'Block';
} else if (Tree_Color_styling_complexity_value == 'Three') {
  Tree_Color_min_container.style.display = 'Block';
}

// Set color to current color
$(Color_min).spectrum("set", conversion[Tree_Color_styling_Data_value][0]);
$(Color_max).spectrum("set", conversion[Tree_Color_styling_Data_value][1]);

}

// Select the Render Plot button
const RenderTree_ColorButton = document.querySelector('#RenderTree_ColorStyling');
// Add click event listener to the button
RenderTree_ColorButton.addEventListener('click', function() {

// Color complexity
const Tree_Color_styling_complexity = document.querySelector('#Tree_color_styling_complexity');
const Tree_Color_styling_Data = document.getElementById("Tree_color_styling");

const Tree_Color_styling_complexity_value = Tree_Color_styling_complexity.value;
const Tree_Color_styling_Data_value = Tree_Color_styling_Data.value;

// Color picker values 
const Color_min = document.getElementById("Tree_colorPicker_min");
const Color_max = document.getElementById("Tree_colorPicker_max");


if (Tree_Color_styling_complexity_value == 'One') {
  const One_Color_value = $(Color_max).spectrum("get").toHexString();
  conversion[Tree_Color_styling_Data_value][0] = '#FFFFFF';
  conversion[Tree_Color_styling_Data_value][1] = One_Color_value;
  Tree_circle_styling_dict[Tree_Color_styling_Data_value] = 'Two';
} else if (Tree_Color_styling_complexity_value == 'Two') {
  const Two_Color_value_min = $(Color_min).spectrum("get").toHexString();
  const Two_Color_value_max = $(Color_max).spectrum("get").toHexString();
  conversion[Tree_Color_styling_Data_value][0] = Two_Color_value_min;
  conversion[Tree_Color_styling_Data_value][1] = Two_Color_value_max;
  Tree_circle_styling_dict[Tree_Color_styling_Data_value] = 'Two';
} else if (Tree_Color_styling_complexity_value == 'Three') {
  const Two_Color_value_min = $(Color_min).spectrum("get").toHexString();
  const Two_Color_value_max = $(Color_max).spectrum("get").toHexString();
  conversion[Tree_Color_styling_Data_value][0] = Two_Color_value_min;
  conversion[Tree_Color_styling_Data_value][1] = Two_Color_value_max;
  Tree_circle_styling_dict[Tree_Color_styling_Data_value] = 'Three';
}

DrawCircles('tree_plot', Tree_circles, maxLeafNodeLenght, conversion, true, true,Tree_circle_styling_dict,circle_spacer,circle_size);
createLegendBars('legend_bars', Tree_circles, conversion,Tree_circle_styling_dict);
});

// #################
// # Label styling #
// #################

// Function to update the option text based on depth
function updateLabelOptions(depth) {
      if (depth === 3) {
          const selector = document.getElementById('Tree_Styling_layerSelector');
          // Clear all existing options
          selector.innerHTML = `
              <option value="class">Ligand type</option>
              <option value="ligandtype">Receptor family</option>
              <option value="receptorfamily">Receptor</option>
          `;
      }
      // No need to do anything if depth is 4, options remain as initialized
  }

  // Example: Assuming tree_options.depth is available as a global variable
  // Call the function when the page loads or when depth changes
  document.addEventListener('DOMContentLoaded', function() {
      const depth = tree_options.depth;  // Get the depth value from your tree_options
      updateLabelOptions(depth);
  });

function Tree_updateLabelStyling() {
  var layerSelector = document.getElementById("Tree_Styling_layerSelector");
  var fontSizeSlider = document.getElementById("Tree_fontSizeSlider");

  if (layerSelector.value === "class") {
      fontSizeSlider.max = 20;
  } else if ((layerSelector.value === "ligandtype")) {
    fontSizeSlider.max = 21;
  } else if ((layerSelector.value === "receptorfamily")) {
    fontSizeSlider.max = 22;
  } else {
      // Reset to default max value
      fontSizeSlider.max = 23;
  }
}

// Update the font size label based on slider value
const Tree_fontSizeSlider = document.getElementById('Tree_fontSizeSlider');
const Tree_fontSizeLabel = document.getElementById('Tree_fontSizeSliderLabel');
Tree_fontSizeSlider.addEventListener('input', () => {
Tree_fontSizeLabel.textContent = `Font Size: ${Tree_fontSizeSlider.value}px`;
});

// Get the layer selector dropdown element
const Tree_label_selector = document.getElementById("Tree_Styling_layerSelector");

// Add event listener to the layer selector dropdown
Tree_label_selector.addEventListener("change", function() {
  // Get the selected layer value
  const Tree_label_selector_value = Tree_label_selector.value;

  // Get the styling options for the selected layer from the styling dictionary
  const selected_Label_Styling = tree_options['fontSize'][Tree_label_selector_value];
  
  // set fontsize to current value
  // const Tree_fontsize_value = document.getElementById("Tree_fontSizeSlider")
  document.getElementById("Tree_fontSizeSlider").value = parseInt(selected_Label_Styling);

  // Update the label for font size slider
  document.getElementById("Tree_fontSizeSliderLabel").textContent = "Font Size: " + selected_Label_Styling;

});

// Select the Render Plot button
const RenderTree_LabelButton = document.querySelector('#renderTreePlot_label');
// Add click event listener to the button
RenderTree_LabelButton.addEventListener('click', function() {

// Get selected value and input from slider 
// Selected branch
const Tree_label_selector = document.getElementById("Tree_Styling_layerSelector");
const Tree_label_selector_value = Tree_label_selector.value;
// slider value 
const Tree_slider_value = document.getElementById("Tree_fontSizeSlider").value;

tree_options['fontSize'][Tree_label_selector_value] = `${Tree_slider_value}px`;

// recalculate maxn node length
if (tree_options.depth == 4) {
      maxLeafNodeLenght = 4*parseInt(tree_options.fontSize.receptor);
    } else if (tree_options.depth == 3) {
      maxLeafNodeLenght = 4*parseInt(tree_options.fontSize.receptorfamily);
    }
// maxLeafNodeLenght = 4*parseInt(tree_options.fontSize.receptor);

// render tree
draw_tree(tree_data, tree_options,circle_size);
DrawCircles('tree_plot', Tree_circles, maxLeafNodeLenght, conversion, true, true,Tree_circle_styling_dict,circle_spacer,circle_size);

});
// ##################
// ## Data styling ##
// ##################

// Update slider value
document.getElementById('Tree_circleSizeSlider').addEventListener('input', function() {
  document.getElementById('Tree_circleSizeValue').textContent = this.value;
});

document.getElementById('Tree_circleSpacerSlider').addEventListener('input', function() {
  document.getElementById('Tree_circleSpacerValue').textContent = this.value;
});

// Circle size and spacer render
// Select the Render Plot button
const RenderTree_CircleButton = document.querySelector('#renderTreePlot_Circles');
// Add click event listener to the button
RenderTree_CircleButton.addEventListener('click', function() {

// Get input from sliders 
const Tree_Slider_circesize = document.getElementById("Tree_circleSizeSlider");
const Tree_Slider_circesize_value = Tree_Slider_circesize.value;
const Tree_Slider_circespacer = document.getElementById("Tree_circleSpacerSlider");
const Tree_Slider_circespacer_value = Tree_Slider_circespacer.value;

// recalculate circle size and spacer
circle_size = 3+1*Tree_Slider_circesize_value;
circle_spacer = circle_size*(2+0.5*Tree_Slider_circespacer_value)+1;

// render tree
draw_tree(tree_data, tree_options,circle_size);
DrawCircles('tree_plot', Tree_circles, maxLeafNodeLenght, conversion, true, true,Tree_circle_styling_dict,circle_spacer,circle_size);


});



</script>
{% endif %}

<!-- ################## -->
<!-- ###  Cluster   ### -->
<!-- ################## -->
{% if Plot_evaluation_json.1 %}
<script>

$('.dropdown-menu').on('click', function(event){
    event.stopPropagation();
});


// Global variable to store the cluster data
 // Global variables for cluster data
 var cluster_data_seq = {{ cluster_data_seq|safe }};
  // var cluster_data_structure = {{ cluster_data_structure|safe }};
  var currentClusterData = cluster_data_seq; // Default to cluster_data_seq

// Predefined color palette
const colorPalette = [
    '#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd',
    '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'
];

// Function to download the plot
function downloadPlot(format) {
    const plotElement = document.getElementById('plotContainer_umap');

    Plotly.toImage(plotElement, {
        format: format,
        height: 1200,
        width: 1600,
        scale: 1
    }).then(function (dataUrl) {
        const link = document.createElement('a');
        link.href = dataUrl;
        link.download = `plot.${format}`;
        link.click();
    }).catch(function (error) {
        console.error('Error exporting plot:', error);
    });
}

// Document ready function
$(document).ready(function() {

    // Attach click event handlers to switch between datasets
    // $('#datasetSeq').click(function() {
    //     currentClusterData = cluster_data_seq;
    //     renderInitialPlot();
    //     // const activeColorOption = getActiveColorOption();
    //     // updatePlot(activeColorOption);
    // });

    // $('#datasetStructure').click(function() {
    //     currentClusterData = cluster_data_structure;
    //     // const activeColorOption = getActiveColorOption();
    //     // updatePlot(activeColorOption);
    //     renderInitialPlot();
    // });

    // Event listeners for color options
    $("#colorByCluster").on("click", function() {
        setActiveButton("colorByCluster");
        updatePlot('cluster');
    });

    $("#colorByGradient").on("click", function() {
        setActiveButton("colorByGradient");
        updatePlot('gradient');
    });

    $("#colorByClass").on("click", function() {
        setActiveButton("colorByClass");
        updatePlot('Class');
    });

    $("#colorByLigandType").on("click", function() {
        setActiveButton("colorByLigandType");
        updatePlot('Ligand type');
    });

    $("#colorByReceptorFamily").on("click", function() {
        setActiveButton("colorByReceptorFamily");
        updatePlot('Receptor family');
    });

    // Show/hide labels
    document.getElementById("show").addEventListener("click", function() {
        document.getElementById("show").classList.add("active");
        document.getElementById("hide").classList.remove("active");
        const activeColorOption = getActiveColorOption();
        updatePlot(activeColorOption);
    });

    document.getElementById("hide").addEventListener("click", function() {
        document.getElementById("show").classList.remove("active");
        document.getElementById("hide").classList.add("active");
        const activeColorOption = getActiveColorOption();
        updatePlot(activeColorOption);
    });

    // Clustering options
    const clusterSlider = document.getElementById('clusterSlider');
    const clusterSliderValue = document.getElementById('clusterSliderValue');
    const renderClusterPlotButton = document.getElementById('renderClusterPlot');

    clusterSlider.addEventListener('input', function() {
        clusterSliderValue.textContent = clusterSlider.value;
    });

    renderClusterPlotButton.addEventListener('click', function() {
        const numClusters = parseInt(clusterSlider.value, 10);
        performClustering(numClusters);
    });

    // Initial plot rendering on page load
    renderInitialPlot();

    // Event listener for "Rerender Labels" button
    document.getElementById("rerenderLabels").addEventListener("click", function() {
      const activeColorOption = getActiveColorOption();
      updatePlot(activeColorOption);
    });
});

// Function to set the active button and deactivate others
function setActiveButton(activeButtonId) {
    const colorOptions = ["colorByCluster", "colorByGradient", "colorByClass", "colorByLigandType", "colorByReceptorFamily"];
    
    colorOptions.forEach(function(option) {
        if (option === activeButtonId) {
            $("#" + option).addClass("active");
        } else {
            $("#" + option).removeClass("active");
        }
    });
}

// Function to get the active color option
function getActiveColorOption() {
    if (document.getElementById('colorByCluster').classList.contains('active')) {
        return 'cluster';
    } else if (document.getElementById('colorByGradient').classList.contains('active')) {
        return 'gradient';
    } else if (document.getElementById('colorByClass').classList.contains('active')) {
        return 'Class';
    } else if (document.getElementById('colorByLigandType').classList.contains('active')) {
        return 'Ligand type';
    } else if (document.getElementById('colorByReceptorFamily').classList.contains('active')) {
        return 'Receptor family';
    }
    return 'cluster'; // Default to 'cluster' if no option is active
}

// Function to create traces for the plot
function createTraces(colorOption, showLabels) {
    
  let traces = [];
  let colorMapping = {};
  
  if (['Class', 'Ligand type', 'Receptor family'].includes(colorOption)) {
        const uniqueValues = Array.from(new Set(currentClusterData.map(d => d[colorOption])));
        uniqueValues.forEach((value, index) => {
            colorMapping[value] = colorPalette[index % colorPalette.length];
        });
    }
  
  const clusterSet = Array.from(new Set(currentClusterData.map(d => d.cluster))).sort((a, b) => a - b);

  if (colorOption === 'cluster') {
        clusterSet.forEach(cluster => {
            const clusterData = currentClusterData.filter(d => d.cluster === cluster);

            const markerTrace = {
                x: clusterData.map(d => d.x),
                y: clusterData.map(d => d.y),
                mode: 'markers',
                type: 'scatter',
                hoverinfo: 'text',  // Show labels on hover
                text: clusterData.map(d => d.label),  // Use labels as hover text
                marker: {
                    size: 10,
                    symbol: 'circle',
                    color: clusterData.map(d => colorPalette[d.cluster % colorPalette.length]),
                },
                name: `Cluster ${cluster}`
            };

            traces.push(markerTrace);
        });
      } else if (colorOption === 'gradient') {
        const gradientTrace = {
            x: currentClusterData.map(d => d.x),
            y: currentClusterData.map(d => d.y),
            mode: 'markers',
            type: 'scatter',
            hoverinfo: 'text',  // Show labels on hover
            text: currentClusterData.map(d => `${d.label}: ${d.fill}`),  // Combine label and fill with a hyphen for hover text
            marker: {
                size: 10,
                symbol: 'circle',
                color: currentClusterData.map(d => d.fill),
                coloraxis: 'coloraxis'
            },
            showlegend: false
        };

        traces.push(gradientTrace);
          
      } else if (['Class', 'Ligand type', 'Receptor family'].includes(colorOption)) {
              const uniqueEntries = new Set();

              currentClusterData.forEach(point => {
                  const entry = point[colorOption];
                  if (!uniqueEntries.has(entry)) {
                      uniqueEntries.add(entry);

                      const markerTrace = {
                          x: currentClusterData.filter(d => d[colorOption] === point[colorOption]).map(d => d.x),
                          y: currentClusterData.filter(d => d[colorOption] === point[colorOption]).map(d => d.y),
                          mode: 'markers',
                          type: 'scatter',
                          hoverinfo: 'text',  // Show labels on hover
                          text: currentClusterData.filter(d => d[colorOption] === point[colorOption]).map(d => d.label),  // Use labels as hover text
                          marker: {
                              size: 10,
                              symbol: 'circle',
                              color: colorMapping[point[colorOption]],
                          },
                          name: entry
                      };

                      traces.push(markerTrace);
                  }
              });
        }
        return traces;
  }



// Function to plot labels, avoiding overlap with markers and each other
function plotLabels(showLabels, xRange = null, yRange = null) {
    if (!showLabels) {
        return null; // Return null if labels are not to be shown
    }

    // Ensure xRange and yRange are not null and have default values
    xRange = xRange || [0, 1];
    yRange = yRange || [0, 1];

    const filteredData = currentClusterData.filter(d => {
        const inXRange = (d.x >= xRange[0] && d.x <= xRange[1]);
        const inYRange = (d.y >= yRange[0] && d.y <= yRange[1]);
        return inXRange && inYRange;
    });

    // Basic strategy to position labels around markers
    const labels = filteredData.map(d => ({
        x: d.x,
        y: d.y,
        text: d.label,
        position: getDefaultLabelPosition()
    }));

    // Adjust label positions based on zoom level and avoid overlap
    const adjustedLabels = adjustAndAvoidOverlaps(labels, xRange, yRange);

    return {
        x: adjustedLabels.map(d => d.x),
        y: adjustedLabels.map(d => d.y),
        mode: 'text',
        type: 'scatter',
        text: adjustedLabels.map(d => d.text),
        textfont: {
            family: 'Arial',
            size: 12,
            color: '#000000'
        },
        hoverinfo: 'none',
        showlegend: false
    };
}

// Function to get default label position around the marker
function getDefaultLabelPosition() {
    const textPositions = ['middle left', 'top left', 'bottom left', 'top right', 'bottom right', 'middle right'];
    return textPositions[Math.floor(Math.random() * textPositions.length)];
}

// Function to get offset based on label position
function getLabelOffset(position, minDistance) {
    switch (position) {
        case 'middle left':
            return { x: -1 * minDistance, y: 0 };
        case 'top left':
            return { x: -1 * minDistance, y: minDistance };
        case 'bottom left':
            return { x: -1 * minDistance, y: -1 * minDistance };
        case 'top right':
            return { x: minDistance, y: minDistance };
        case 'bottom right':
            return { x: minDistance, y: -1 * minDistance };
        case 'middle right':
            return { x: minDistance, y: 0 };
        default:
            return { x: 0, y: 0 };
    }
}

// Combined function to adjust label positions and avoid overlaps
function adjustAndAvoidOverlaps(labels, xRange, yRange) {
    const rangeWidth = xRange ? (xRange[1] - xRange[0]) : 1;
    const minDistance = rangeWidth * 0.05; // Scale factor for minimum distance
    const offsetScale = rangeWidth * 0.03; // Scale factor for label offset

    // Initial adjustment for label positions based on zoom level
    let adjustedLabels = labels.map(label => {
        const offset = getLabelOffset(label.position, offsetScale);
        return {
            x: label.x + offset.x,
            y: label.y + offset.y,
            text: label.text
        };
    });

    // Adjust label positions to avoid overlap with each other
    adjustedLabels = avoidLabelOverlaps(adjustedLabels, minDistance);

    // Further adjust labels to ensure they are within plot bounds
    adjustedLabels = adjustedLabels.map(label => ({
        x: Math.min(Math.max(label.x, xRange[0]), xRange[1]),
        y: Math.min(Math.max(label.y, yRange[0]), yRange[1]),
        text: label.text
    }));

    return adjustedLabels;
}

// Function to avoid label overlaps with each other
function avoidLabelOverlaps(labels, minDistance) {
    const avoidOverlap = (labels) => {
        for (let i = 0; i < labels.length; i++) {
            for (let j = i + 1; j < labels.length; j++) {
                const dx = labels[i].x - labels[j].x;
                const dy = labels[i].y - labels[j].y;
                const distance = Math.sqrt(dx * dx + dy * dy);

                if (distance < minDistance) {
                    // If overlap, move label j away from label i
                    const moveAmount = (minDistance - distance) * 0.5;
                    labels[j].x += moveAmount * (dx / distance);
                    labels[j].y += moveAmount * (dy / distance);
                }
            }
        }
    };

    avoidOverlap(labels);
    return labels;
}



// Function to render the initial plot
function renderInitialPlot() {
    const colorOption = getActiveColorOption(); // Get the initially selected color option
    const showLabels = document.getElementById('show').classList.contains('active');

    performClustering(5);

    const traces = createTraces(colorOption, showLabels);

    // Capture current layout to preserve zoom state
    const plotElement = document.getElementById('plotContainer_umap');
    const currentLayout = plotElement ? Plotly.d3.select('#plotContainer_umap').node().layout : {};

    // Safely extract xaxis and yaxis ranges with default values
    const xRange = (currentLayout && currentLayout.xaxis && currentLayout.xaxis.range) ? currentLayout.xaxis.range : null;
    const yRange = (currentLayout && currentLayout.yaxis && currentLayout.yaxis.range) ? currentLayout.yaxis.range : null;

    // Plot labels initially
    const labelTrace = plotLabels(showLabels,xRange,yRange);
    if (labelTrace) {
        traces.push(labelTrace);
    }

    // Define new layout with fixed dimensions
    const layout = {
        xaxis: {
            visible: false,
            showgrid: false,
            range: xRange,  // Restore x-axis range from current layout
            scaleanchor: 'y'  // Ensure the aspect ratio is preserved
        },
        yaxis: {
            visible: false,
            showgrid: false,
            range: yRange,  // Restore y-axis range from current layout
        },
        hovermode: 'closest',
        showlegend: true,
        legend: {
            x: 1,
            xanchor: 'left',
            y: 0.5,
            orientation: 'v'
        },
        plot_bgcolor: '#FFFFFF',
        autosize: false,
        width: 1024,  // Total plot width: 600px (plot area) + 324px (legend area) + margins
        height: 700,  // Total height to accommodate the plot area and some extra space
        margin: {
            l: 50,   // Left margin
            r: 374,  // Right margin (to accommodate legend and some spacing)
            t: 50,   // Top margin
            b: 50    // Bottom margin
        },
        coloraxis: colorOption === 'gradient' ? {
            colorscale: 'RdBu',
            colorbar: {
                thickness: 20,
                len: 0.5,
                title: {
                    text: 'Fill Gradient',
                    side: 'right'
                },
            }
        } : undefined
    };

    Plotly.newPlot('plotContainer_umap', traces, layout);

    // // Add zoom event to the plot
    plotElement.on('plotly_relayout', function(eventdata) {
      const showLabels = document.getElementById('show').classList.contains('active');
      // Capture current layout to preserve zoom state
      const plotElement = document.getElementById('plotContainer_umap');
      const currentLayout = plotElement ? Plotly.d3.select('#plotContainer_umap').node().layout : {};

      // Safely extract xaxis and yaxis ranges with default values
      const xRange = (currentLayout && currentLayout.xaxis && currentLayout.xaxis.range) ? currentLayout.xaxis.range : null;
      const yRange = (currentLayout && currentLayout.yaxis && currentLayout.yaxis.range) ? currentLayout.yaxis.range : null;

      // Plot labels initially
      const labelTrace = plotLabels(showLabels,xRange,yRange);
      if (labelTrace) {
          traces.push(labelTrace);
      }
      const activeColorOption = getActiveColorOption();
      updatePlot(activeColorOption);
    });

    // Auto-scale the axes after the plot is initially rendered
    Plotly.relayout(plotElement, {
        'xaxis.autorange': true,
        'yaxis.autorange': true
    });
}

// Function to update the plot based on color option
function updatePlot(colorOption) {
    const showLabels = document.getElementById('show').classList.contains('active');
    const traces = createTraces(colorOption, showLabels);

    // Capture current layout to preserve zoom state
    const plotElement = document.getElementById('plotContainer_umap');
    const currentLayout = plotElement ? Plotly.d3.select('#plotContainer_umap').node().layout : {};

    // Safely extract xaxis and yaxis ranges with default values
    const xRange = (currentLayout && currentLayout.xaxis && currentLayout.xaxis.range) ? currentLayout.xaxis.range : null;
    const yRange = (currentLayout && currentLayout.yaxis && currentLayout.yaxis.range) ? currentLayout.yaxis.range : null;

    const labelTrace = plotLabels(showLabels, xRange, yRange);
    if (labelTrace) {
        traces.push(labelTrace);
    }

    // Define new layout with fixed dimensions
    const layout = {
        xaxis: {
            visible: false,
            showgrid: false,
            range: xRange,  // Restore x-axis range from current layout
            scaleanchor: 'y'  // Ensure the aspect ratio is preserved
        },
        yaxis: {
            visible: false,
            showgrid: false,
            range: yRange,  // Restore y-axis range from current layout
        },
        hovermode: 'closest',
        showlegend: true,
        legend: {
            x: 1,
            xanchor: 'left',
            y: 0.5,
            orientation: 'v'
        },
        plot_bgcolor: '#FFFFFF',
        autosize: false,
        width: 1024,  // Total plot width: 600px (plot area) + 324px (legend area) + margins
        height: 700,  // Total height to accommodate the plot area and some extra space
        margin: {
            l: 50,   // Left margin
            r: 374,  // Right margin (to accommodate legend and some spacing)
            t: 50,   // Top margin
            b: 50    // Bottom margin
        },
        coloraxis: colorOption === 'gradient' ? {
            colorscale: 'RdBu',
            colorbar: {
                thickness: 20,
                len: 0.5,
                title: {
                    text: 'Fill Gradient',
                    side: 'right'
                },
            }
        } : undefined
    };

    // Use Plotly.react to update the plot while preserving the zoom state
    Plotly.react('plotContainer_umap', traces, layout);
}

// Function to perform clustering
function performClustering(numClusters) {
    const data = currentClusterData;
    const coordinates = data.map(d => [d.x, d.y]);

    if (typeof ML.KMeans === 'function') {
        const options = {
            maxIterations: 100,
            tolerance: 1e-6,
            initialization: 'kmeans++'
        };

        const result = ML.KMeans(coordinates, numClusters, options);

        data.forEach((point, idx) => {
            point.cluster = result.clusters[idx]; // Update only the cluster value
        });
        
        currentClusterData = data; // Update cluster_data
        setActiveButton("colorByCluster");
        updatePlot('cluster');  // Pass 'cluster' as the color option
    } else {
        console.error('kmeans-js library not loaded correctly.');
    }
}

</script>
{% endif %}

<!-- ################## -->
<!-- ###    List    ### -->
<!-- ################## -->

{% if Plot_evaluation_json.2 %}

<script>
  $(document).ready(function() {
    // Function to initialize Spectrum color picker
    function initializeColorPicker(elementId) {
      $("#" + elementId).spectrum({
        color: "#000",
        showPalette: true,
        showInput: true,
        preferredFormat: "hex",
        palette: [
          ["#000", "#FF0000", "#00FF00", "#0000FF", "#FFFF00"],
          ["#FF00FF", "#00FFFF", "#FFFFFF", "#C0C0C0", "#808080"],
          ["#800000", "#808000", "#008000", "#800080", "#008080"],
          ["#000080"]
        ],
        change: function(color) {
          var selectedColor = color.toHexString();
        }
      });
    }
    // Initialize all color pickers
    initializeColorPicker("colorPicker_LabelStyling");
    initializeColorPicker("OneColor_DataStyling");
    initializeColorPicker("TwoColor_DataStyling_one");
    initializeColorPicker("TwoColor_DataStyling_two");
  });
</script>

<script>

// #####################
// # Load view context #
// #####################

var listdata = {{ listplot_data|safe }};
var list_data_wow = {{ listplot_data_variables|safe }};
var data_types_list = {{listplot_datatypes|safe}};
var Label_conversion_dict = {{Label_Conversion|safe}};

// #################################
// ## Initialize global variables ##
// #################################


// # Initialize layout #
var Layout_dict = {columns: 2, col_breaker: 'Custom', col_max_label: 'Auto', indentation: 'Yes'};

//  Initialize styling
var Styling_Option_dict = {
    Layer1: {Bold: true, Italic: false, Underline: false, Fontsize: "20px", Color: "#000"},
    Layer2: {Bold: true, Italic: false, Underline: false, Fontsize: "18px", Color: "#000"},
    Layer3: {Bold: false, Italic: false, Underline: false, Fontsize: "16px", Color: "#000"},
    Layer4: {Bold: false, Italic: false, Underline: false, Fontsize: "14px", Color: "#000"}};

// # Initialize label switcher #
var Label_names = 'IUPHAR';

// # Initialize data styling #
var Data_styling = initializeDataStyling(list_data_wow, data_types_list);


// #################################
// # Initialize data visualization #
// #################################

document.addEventListener("DOMContentLoaded", function() {


  renderDataVisualization(listdata, 'ListPlot',Styling_Option_dict,Layout_dict,Data_styling,Label_conversion_dict,Label_names);

  // Data styling render button functionality *** Add for the other buttons! ***
  const renderPlotButton_dataStyling = document.querySelector('#DataStyling_renderPlotButton');
  const dataStylingSelector = document.querySelector('#Data_Styling_Selector');

  // Add event listeners to the dropdowns to check their values
  dataStylingSelector.addEventListener('change', checkDropdownValues);

  function checkDropdownValues() {
    const dataStylingValue = dataStylingSelector.value;
    const dataTypeValue = ColorComplexityDropdown.value;

    // Enable the button if both dropdowns have valid values
    if (dataStylingValue !== 'Select Data') {
      renderPlotButton_dataStyling.disabled = false;
    } else {
      renderPlotButton_dataStyling.disabled = true;
    }
  }
});

// Function to update the visualization
function updateVisualization() {
      // Clear existing SVG content
      d3.select("#ListPlot_visualization").remove();
      // Re-render the visualization
      renderDataVisualization(listdata, "ListPlot",Styling_Option_dict,Layout_dict,Data_styling,Label_conversion_dict,Label_names);
    }

// Add event listeners to checkboxes
d3.selectAll('input[type="checkbox"]').on("change", updateVisualization);

$('.dropdown-menu').on('click', function(event){
    event.stopPropagation();
  });

// Update the font size label based on slider value
const fontSizeSlider = document.getElementById('fontSizeSlider');
const fontSizeLabel = document.getElementById('fontSizeSliderLabel');
fontSizeSlider.addEventListener('input', () => {
  fontSizeLabel.textContent = `Font Size: ${fontSizeSlider.value}px`;
});

// #####################
// ## Layout options  ##
// #####################

// Select the Render Plot button
const renderPlotButton_Layout = document.querySelector('#RenderLayoutButton_Layout');

// Add click event listener to the button
renderPlotButton_Layout.addEventListener('click', function() {

  // Select the layer selector dropdown
  const layerSelector_layout = document.querySelector('#Layout_Column_Selector');
  const layerBreaker_layout = document.querySelector('#Layout_Column_Breaker');

  // Get the selected layer value
  const Layout_selectedLayer = layerSelector_layout.value;
  const Layout_selectedLayerBreaker = layerBreaker_layout.value;

  // var checkbox = document.getElementById('toggle-indentation');
  //   if (checkbox.checked) {
  //       Layout_dict.indentation = 'Yes';
  //   } else {
  //       Layout_dict.indentation = 'No';
  //   }

  // Update function
  function UpdateLayout() {
      // Get values

      const Cols = parseInt(document.querySelector("#Layout_Column_Selector").value);
      const LayerBreak = document.querySelector("#Layout_Column_Breaker").value;
      const Max_label_selector = document.querySelector("#Layout_Max_Label").value;
      const Max_label_number = parseInt(document.querySelector("#Layout_Max_Label_input").value);

      // Handle Max label number
      if (Max_label_selector == 'Auto') {
        Layout_dict.col_max_label = 'Auto';
      } else if (Max_label_selector == 'Custom'){
        Layout_dict.col_max_label = 'Custom';
        Layout_dict.Col_break_number = Max_label_number;
      }

      // update values
      Layout_dict.columns = Cols;
      Layout_dict.col_breaker = LayerBreak;
      // Update plot
      updateVisualization();
  }

  // Check if the selected layer is "Select Layer"
  if (Layout_selectedLayer === "Select Column Number" || Layout_selectedLayerBreaker === "Select Layer Beaker") {
    if (Layout_selectedLayer === "Select Column Number" && Layout_selectedLayerBreaker === "Select Layer Beaker") {
      alert("You need to select both a number of columns and select a layer that breaks the columns.");
      return;
    } else if (Layout_selectedLayer === "Select Column Number") {
      alert("You need to select a number of columns.");
      return;
    }  else if (Layout_selectedLayerBreaker === "Select Layer Beaker") {
      alert("You need to select a layer that breaks the columns.");
      return;
    }
  } else {
    UpdateLayout()
  }
});


// #####################
// ## Styling options ##
// #####################

// Select the Render Plot button
const renderPlotButton = document.querySelector('#renderPlotButton');

// Add click event listener to the button
renderPlotButton.addEventListener('click', function() {
  // Select the layer selector dropdown
  const layerSelector = document.querySelector('#Styling_layerSelector');

  // Get the selected layer value
  const selectedLayer = layerSelector.value;

  // Update function
  function UpdateLayer(selectedLayer) {
      // Get values
      const boldCheckbox = document.getElementById("boldCheckbox").checked
      const italicCheckbox = document.getElementById("italicCheckbox").checked
      const underlineCheckbox = document.getElementById("underlineCheckbox").checked
      const fontsizeslider = `${document.getElementById("fontSizeSlider").value}px`
      // const color = document.querySelector("#Styling_colors").value;
      const colorPicker_LabelStyling = document.getElementById("colorPicker_LabelStyling");

      // update values
      Styling_Option_dict[selectedLayer].Bold = boldCheckbox;
      Styling_Option_dict[selectedLayer].Italic = italicCheckbox;
      Styling_Option_dict[selectedLayer].Underline = underlineCheckbox;
      Styling_Option_dict[selectedLayer].Fontsize = fontsizeslider;

      // Get the selected color from the Spectrum color picker
      const One_Color_value = $(colorPicker_LabelStyling).spectrum("get").toHexString();

      Styling_Option_dict[selectedLayer].Color = One_Color_value;

      // Update plot
      updateVisualization();
  }
  // Check if the selected layer is "Select Layer"
  if (selectedLayer === "Select Layer") {
    alert("No Layer has been selected");
    return;
  } else {
    if (selectedLayer === "Layer1" || selectedLayer === "Layer2" || selectedLayer === "Layer3" || selectedLayer === "Layer4") {
      UpdateLayer(selectedLayer);
    }
  }
});

function updateMax() {
    var layerSelector = document.getElementById("Styling_layerSelector");
    var fontSizeSlider = document.getElementById("fontSizeSlider");

    if (layerSelector.value === "Layer3") {
        fontSizeSlider.max = 16;
    } else if ((layerSelector.value === "Layer2")) {
      fontSizeSlider.max = 24;
    } else if ((layerSelector.value === "Layer4")) {
      fontSizeSlider.max = 23;
    } else {
        // Reset to default max value
        fontSizeSlider.max = 28;
    }
  }

// ####################
// ## Update styling ##
// ####################

// Get the layer selector dropdown element
const layerSelector = document.getElementById("Styling_layerSelector");

// Add event listener to the layer selector dropdown
layerSelector.addEventListener("change", function() {
    // Get the selected layer value
    const selectedLayer = layerSelector.value;

    // Get the styling options for the selected layer from the styling dictionary
    const selectedLayerStyling = Styling_Option_dict[selectedLayer];

    // Update the UI elements based on the selected layer's styling options
    document.getElementById("boldCheckbox").checked = selectedLayerStyling.Bold;
    document.getElementById("italicCheckbox").checked = selectedLayerStyling.Italic;
    document.getElementById("underlineCheckbox").checked = selectedLayerStyling.Underline;
    document.getElementById("fontSizeSlider").value = parseInt(selectedLayerStyling.Fontsize);

    // Update the label for font size slider
    document.getElementById("fontSizeSliderLabel").textContent = "Font Size: " + selectedLayerStyling.Fontsize;

    // Set the selected color in the Spectrum color picker
    const colorPicker_LabelStyling = document.getElementById("colorPicker_LabelStyling");
    $(colorPicker_LabelStyling).spectrum("set", selectedLayerStyling.Color);
  });

// ###################
// ## Data styling ##
// ###################

// Function to populate select options based on Data_styling
function populateSelectOptions() {
  var select = document.getElementById("Data_Styling_Selector");

  // Clear existing options
  select.innerHTML = '<option selected>Select Data</option>';

  // Loop through Data_styling and add options for columns with Data: "Yes"
  Object.keys(Data_styling).forEach(function(column) {
    if (Data_styling[column].Data === "Yes" && Data_styling[column].Datatype == 'Continuous') {
      var option = document.createElement("option");
      option.value = column;
      option.textContent = "Data Column " + column.substr(3); // Extract number from column name
      select.appendChild(option);
    }
  });
}

// Call the function to populate options initially
populateSelectOptions();


// Function to update the Datatypes dropdown based on selected data column
function updateColorComplexityDropdown() {
  var dataColumn = document.getElementById("Data_Styling_Selector");
  // var DataColoringDropdown = document.getElementById("DataColoringDropdown")
  var ColorComplexityDropdown = document.getElementById("ColorComplexityDropdown");
  var OneColor_DataStyling = document.getElementById("OneColor_DataStyling_container");
  var TwoColor_DataStyling_One = document.getElementById("TwoColor_DataStyling_One_container");
  var TwoColor_DataStyling_two = document.getElementById("TwoColor_DataStyling_Two_container");

  const dataColumn_value = dataColumn.value;
  const ColorComplexity_value = ColorComplexityDropdown.value;

  if (dataColumn_value === 'Select Data') {
    // Show the dropdown
    ColorComplexityDropdown.style.display = "None";
    // DataColoringDropdown.style.display = "None"
    OneColor_DataStyling.style.display = 'None';
    TwoColor_DataStyling_One.style.display = 'None';
    TwoColor_DataStyling_two.style.display = 'None';
  } else {
    // Hide the dropdown if no Datatypes or if Data.Data !== Yes
    ColorComplexityDropdown.style.display = "Block";
    // DataColoringDropdown.style.display = "Block"
    if (ColorComplexity_value == 'One') {
      OneColor_DataStyling.style.display = 'Block';
    } else {
      TwoColor_DataStyling_One.style.display = 'Block';
      TwoColor_DataStyling_two.style.display = 'Block';
    }
  }
}

function updateColorDropdowns() {
  var ColorComplexityDropdown = document.getElementById("ColorComplexityDropdown");
  var OneColor_DataStyling = document.getElementById("OneColor_DataStyling_container");
  var TwoColor_DataStyling_One = document.getElementById("TwoColor_DataStyling_One_container");
  var TwoColor_DataStyling_two = document.getElementById("TwoColor_DataStyling_Two_container");

  const ColorComplexity_value = ColorComplexityDropdown.value;

  if (ColorComplexity_value == 'One') {
    OneColor_DataStyling.style.display = 'Block';
    TwoColor_DataStyling_One.style.display = 'None';
    TwoColor_DataStyling_two.style.display = 'None';
  } else {
    OneColor_DataStyling.style.display = 'None';
    TwoColor_DataStyling_One.style.display = 'Block';
    TwoColor_DataStyling_two.style.display = 'Block';
  }
}

// Select the Render Plot button
const renderPlotButton_dataStyling = document.querySelector('#DataStyling_renderPlotButton');
// Add click event listener to the button
renderPlotButton_dataStyling.addEventListener('click', function() {

  // Select the layer selector dropdown
  const Selector_DataStyling = document.querySelector('#Data_Styling_Selector');
  // const DataColoringDropdown = document.getElementById("DataColoringDropdown")
  const ColorComplexityDropdown = document.getElementById("ColorComplexityDropdown");
  const OneColor_DataStyling = document.getElementById("OneColor_DataStyling");
  const TwoColor_DataStyling_One = document.getElementById("TwoColor_DataStyling_one");
  const TwoColor_DataStyling_two = document.getElementById("TwoColor_DataStyling_two");

  const colorPicker_LabelStyling = document.getElementById("colorPicker_LabelStyling");
  // Get the selected layer value
  const Selector_DataStyling_value = Selector_DataStyling.value;
  // const Data_coloring_value = DataColoringDropdown.value;
  const Color_complexity_value = ColorComplexityDropdown.value;


  if (Color_complexity_value == 'One') {
    const One_Color_value = $(OneColor_DataStyling).spectrum("get").toHexString();
    Data_styling[Selector_DataStyling_value].Data_color1 = One_Color_value;
    Data_styling[Selector_DataStyling_value].data_color_complexity = Color_complexity_value;
  } else if (Color_complexity_value == 'Two') {
    const Two_Color_value_one = $(TwoColor_DataStyling_One).spectrum("get").toHexString();
    const Two_Color_value_two = $(TwoColor_DataStyling_two).spectrum("get").toHexString();
    Data_styling[Selector_DataStyling_value].Data_color1 = Two_Color_value_one;
    Data_styling[Selector_DataStyling_value].Data_color2 = Two_Color_value_two;
    Data_styling[Selector_DataStyling_value].data_color_complexity = Color_complexity_value;
  }

  // Update plot
  updateVisualization();

});

// ###################
// ## Label switch ###
// ###################

$("#List_UniProtNames").click(function() {
    $("#List_UniProtNames").addClass("active");
    $("#List_IUPHARNames").removeClass("active");
    Label_names = 'UniProt';
    updateVisualization();
});

$("#List_IUPHARNames").click(function() {
      $("#List_UniProtNames").removeClass("active");
      $("#List_IUPHARNames").addClass("active");
      Label_names = 'IUPHAR';
      updateVisualization();
  });

</script>
{% endif %}

<!-- ############# -->
<!-- ## Heatmap ## -->
<!-- ############# -->
{% if Plot_evaluation_json.3 %}


<script>
  $(document).ready(function() {
    // Function to initialize Spectrum color picker
    function initializeColorPicker(elementId,start_color) {
      $("#" + elementId).spectrum({
        color: start_color,
        showPalette: true,
        showInput: true,
        preferredFormat: "hex",
        palette: [
          ["#000", "#FF0000", "#00FF00", "#0000FF", "#FFFF00"],
          ["#FF00FF", "#00FFFF", "#FFFFFF", "#C0C0C0", "#808080"],
          ["#800000", "#808000", "#008000", "#800080", "#008080"],
          ["#000080"]
        ],
        change: function(color) {
          var selectedColor = color.toHexString();
        }
      });
    }
    // Initialize all color pickers
    initializeColorPicker("Heatmap_colorPicker_min","#1a80bb");
    initializeColorPicker("Heatmap_colorPicker_max","#a00000");
  });
</script>

<script>

var heatmap = {{ heatmap_data|safe }};
var label_converter = {{ Label_converter|safe }};
var label_x_converter = {{Heatmap_Label_dict|safe}};

var heatmap_DataStyling = heatmap_DataStyling();


document.addEventListener("DOMContentLoaded", function() {
  // Initialize heatmap 
  Heatmap(heatmap, 'heatmapPlot', heatmap_DataStyling, label_x_converter);
});

// Function to update the visualization
function Heatmap_updateVisualization() {
      // Clear existing SVG content
      d3.select("#heatmapPlot svg").remove();
      // Re-render the visualization
      Heatmap(heatmap, 'heatmapPlot', heatmap_DataStyling, label_x_converter);
    }

$('.dropdown-menu').on('click', function(event){
  event.stopPropagation();
});


// ###################
// ## Color styling ##
// ###################

function UpdateColorPickers() {
  // Color complexity
  const Color_styling = document.querySelector('#Heatmap_color_styling');

  // Color picker containers 
  const Heatmap_Color_min_container = document.getElementById("Heatmap_Color_min_container");
  // const Heatmap_Color_max_container = document.getElementById("Heatmap_Color_max_container");
  const Color_min = document.getElementById("Heatmap_colorPicker_min");
  const Color_max = document.getElementById("Heatmap_colorPicker_max");

  // Get the selected layer value
  const Color_styling_value = Color_styling.value;

  if (Color_styling_value == 'One') {
    Heatmap_Color_min_container.style.display = 'None';
  } else if (Color_styling_value == 'Two'){
    Heatmap_Color_min_container.style.display = 'Block';
  } else if (Color_styling_value == 'Three') {
    Heatmap_Color_min_container.style.display = 'Block';
  }

  // Set color to current color 
  $(Color_min).spectrum("set", heatmap_DataStyling.min_color);
  $(Color_max).spectrum("set", heatmap_DataStyling.max_color);
  
}

// Function to set color pickers to predefined colors
function setColors(colorMin, colorMax, optionValue) {
    $("#Heatmap_colorPicker_min").spectrum("set", colorMin);
    $("#Heatmap_colorPicker_max").spectrum("set", colorMax);
    $("#Heatmap_color_styling").val(optionValue).trigger("change");
  }

// Event listener for "Set Gray scale" button
$("#GrayScale").click(function() {
  heatmap_DataStyling.min_color = "#b8b8b8";
  heatmap_DataStyling.max_color = "#707070";
  setColors(heatmap_DataStyling.min_color, heatmap_DataStyling.max_color, "Two");
});

// Event listener for "Set Gray-Blue" button
$("#GrayBlueScale").click(function() {
  heatmap_DataStyling.min_color = "#97a6c4";
  heatmap_DataStyling.max_color = "#384860";
  setColors(heatmap_DataStyling.min_color, heatmap_DataStyling.max_color, "Two");
});


// Event listener for "Set Red-Blue" button
$("#RedBlueScale").click(function() {
    heatmap_DataStyling.min_color = "#1a80bb";
    heatmap_DataStyling.max_color = "#a00000";
    setColors(heatmap_DataStyling.min_color, heatmap_DataStyling.max_color, "Three");
  });

// Event listener for "Set teal-Magenta" button
$("#TealMagentaScale").click(function() {
    heatmap_DataStyling.min_color = "#298c8c";
    heatmap_DataStyling.max_color = "#800074";
    setColors(heatmap_DataStyling.min_color, heatmap_DataStyling.max_color, "Three");
  });



// Select the Render Plot button
const RenderHeatmap_ColorButton = document.querySelector('#RenderHeatmap_colering');
// Add click event listener to the button
RenderHeatmap_ColorButton.addEventListener('click', function() {

  // Color complexity
  const Color_styling = document.querySelector('#Heatmap_color_styling');
  // Color pickers 
  const Color_min = document.getElementById("Heatmap_colorPicker_min");
  const Color_max = document.getElementById("Heatmap_colorPicker_max");
  

  // Get color complexity value 
  const Color_styling_value = Color_styling.value;

  if (Color_styling_value == 'One') {
    const One_Color_value = $(Color_max).spectrum("get").toHexString();
    heatmap_DataStyling.min_color = '#FFFFFF';
    heatmap_DataStyling.max_color = One_Color_value;
    heatmap_DataStyling.Number_of_colors = 'One';
  } else if (Color_styling_value == 'Two') {
    const Two_Color_value_min = $(Color_min).spectrum("get").toHexString();
    const Two_Color_value_max = $(Color_max).spectrum("get").toHexString();
    heatmap_DataStyling.min_color = Two_Color_value_min;
    heatmap_DataStyling.max_color = Two_Color_value_max;
    heatmap_DataStyling.Number_of_colors = 'Two';
  } else if (Color_styling_value == 'Three') {
    const Two_Color_value_min = $(Color_min).spectrum("get").toHexString();
    const Two_Color_value_max = $(Color_max).spectrum("get").toHexString();
    heatmap_DataStyling.min_color = Two_Color_value_min;
    heatmap_DataStyling.max_color = Two_Color_value_max;
    heatmap_DataStyling.Number_of_colors = 'Three';
  }
    
  // Update plot
  Heatmap_updateVisualization();

});

// ###################
// ## label styling ##
// ###################

// Select the Render Plot button
const RenderHeatmap_LabelButton = document.querySelector('#RenderHeatmap_labels');
// Add click event listener to the button
RenderHeatmap_LabelButton.addEventListener('click', function() {

  // xLabel oritation & position
  const xLabel_styling_dropdown = document.querySelector('#Heatmap_xlabel_styling');
  const xLabel_position_dropdown = document.querySelector('#Heatmap_xlabel_position');
  const xLabel_fontSizeSlider = document.getElementById('Heatmap_fontSizeSlider');
  const yLabel_fontSizeSlider = document.getElementById('Heatmap_receptor_fontSizeSlider');
  
  // xlabel orientation & position value 
  const xlabel_orientation = parseInt(xLabel_styling_dropdown.value);
  const xlabel_position = xLabel_position_dropdown.value;
  const xlabel_fontsize = xLabel_fontSizeSlider.value;
  const ylabel_fontsize = yLabel_fontSizeSlider.value;

  heatmap_DataStyling.rotation = xlabel_orientation;
  heatmap_DataStyling.label_position = xlabel_position;
  heatmap_DataStyling.label_fontsize = xlabel_fontsize;
  heatmap_DataStyling.receptor_fontsize = ylabel_fontsize;
  
  // Update plot
  Heatmap_updateVisualization();

});

// Update the font size label based on slider value
const Heatmap_fontSizeSlider = document.getElementById('Heatmap_fontSizeSlider');
const Heatmap_fontSizeLabel = document.getElementById('Heatmap_fontSizeSliderLabel');
Heatmap_fontSizeSlider.addEventListener('input', () => {
  Heatmap_fontSizeLabel.textContent = `Label Font Size: ${Heatmap_fontSizeSlider.value}px`;
});

// Update the font size label based on slider value
const Heatmap_receptor_fontSizeSlider = document.getElementById('Heatmap_receptor_fontSizeSlider');
const Heatmap_receptor_fontSizeLabel = document.getElementById('Heatmap_receptor_fontSizeSliderLabel');
Heatmap_receptor_fontSizeSlider.addEventListener('input', () => {
  Heatmap_receptor_fontSizeLabel.textContent = `Receptor Font Size: ${Heatmap_receptor_fontSizeSlider.value}px`;
});


// ###################
// ## Data styling ##
// ###################

// Select the Render Plot button
const RenderHeatmap_DataButton = document.querySelector('#RenderHeatmap_DataStyling');
// Add click event listener to the button
RenderHeatmap_DataButton.addEventListener('click', function() {

  // Border choice
  const Border_styling = document.querySelector('#Heatmap_Border_Styling');
  const data_label_fontsizeSlider = document.getElementById('Heatmap_data_fontSizeSlider');
  // Get color complexity value 
  const Border_styling_value = Border_styling.value;
  const data_fontsize = data_label_fontsizeSlider.value;

  if (Border_styling_value === 'No') {
    heatmap_DataStyling.data_border = false;
  } else if (Border_styling_value === 'Yes') {
    heatmap_DataStyling.data_border = true;
  }

  heatmap_DataStyling.data_fontsize = data_fontsize;
  // Update plot
  Heatmap_updateVisualization();

});


// Update the font size label based on slider value
const Heatmap_data_fontSizeSlider = document.getElementById('Heatmap_data_fontSizeSlider');
const Heatmap_data_fontSizeLabel = document.getElementById('Heatmap_data_fontSizeSliderLabel');
Heatmap_data_fontSizeSlider.addEventListener('input', () => {
  Heatmap_data_fontSizeLabel.textContent = `Data Label Font Size: ${Heatmap_data_fontSizeSlider.value}px`;
});

// ########################
// ## Toggle data labels ##
// ########################

document.addEventListener('DOMContentLoaded', (event) => {
    

    const toggleButton = document.getElementById('Heatmap_data_labels');

    toggleButton.addEventListener('click', () => {
      heatmap_DataStyling.datalabels = !heatmap_DataStyling.datalabels; // Toggle the state

        // Update the button appearance
        if (heatmap_DataStyling.datalabels) {
            toggleButton.classList.add('active');
            toggleButton.classList.remove('btn-primary');
            toggleButton.classList.add('btn-success');
        } else {
            toggleButton.classList.remove('active');
            toggleButton.classList.remove('btn-success');
            toggleButton.classList.add('btn-primary');
        }
        // Rerender heatmap
        Heatmap_updateVisualization();
    });
});


// ###################
// ## Label switch ###
// ###################

$("#Heatmap_UniProtNames").click(function() {
    $("#Heatmap_UniProtNames").addClass("active");
    $("#Heatmap_IUPHARNames").removeClass("active");
    heatmap_DataStyling.LabelType = 'UniProt';
    Heatmap_updateVisualization();
});

$("#Heatmap_IUPHARNames").click(function() {
      $("#Heatmap_UniProtNames").removeClass("active");
      $("#Heatmap_IUPHARNames").addClass("active");
      heatmap_DataStyling.LabelType = 'IUPHAR';
      Heatmap_updateVisualization();
  });

</script>
{% endif %}
<!-- ############# -->
<!-- ## Dart ## -->
<!-- ############# -->
{% if Plot_evaluation_json.4 %}
<script>

$('.dropdown-menu').on('click', function(event){
    event.stopPropagation();
});


var Dart_categories_data = {{ Dart_data|safe }};
var fill_data = {{ Dart_data_variables|safe }};
var Dart_data_types = {{Dart_datatypes|safe}};
var Dart_Label_conversion_dict = {{Dart_Label_Conversion|safe}};



console.log(Dart_data_types)

// Initialize the conversion dictionary
Dart_Label_conversion_dict = initializeDartLabelConversionDict(Dart_Label_conversion_dict);

function initializeDartLabelConversionDict(conversionDict) {
    const updatedDict = {};

    Object.keys(conversionDict).forEach(originalLabel => {
        let uniProtLabel = conversionDict[originalLabel];
        uniProtLabel = uniProtLabel.replace(/_human$/, "").toUpperCase(); // Remove "_human" and convert to uppercase
        updatedDict[originalLabel] = uniProtLabel;
    });

    return updatedDict;
}


// # Initialize data styling #
var layout_data = Dart_initializeData(Dart_categories_data);

const Dart_fill_data_values = Object.values(fill_data).map(receptor => receptor.Value1);

const Dart_fill_minValue = Math.min(...Dart_fill_data_values);
const Dart_fill_maxValue = Math.max(...Dart_fill_data_values);

// Calculate median
// Sort the values in ascending order
Dart_fill_data_values.sort((a, b) => a - b);

// Calculate the median
let Dart_fill_medianValue;
const middleIndex = Math.floor(Dart_fill_data_values.length / 2);

if (Dart_fill_data_values.length % 2 === 0) {
    // Even number of elements, median is the average of the two middle values
    Dart_fill_medianValue = (Dart_fill_data_values[middleIndex - 1] + Dart_fill_data_values[middleIndex]) / 2;
} else {
    // Odd number of elements, median is the middle value
    Dart_fill_medianValue = Dart_fill_data_values[middleIndex];
}

var Darts_styling = {
  Spacing: true,
  family: true,
  datatype: Dart_data_types.Dart.Col1,
  minValue: Dart_fill_minValue,
  median_value: Dart_fill_medianValue,
  maxValue: Dart_fill_maxValue,
  colorStart: "#e64b35",
  color_median: "#4dbbd5",
  colorEnd: "#3c5488"
}

console.log(Darts_styling.minValue,Darts_styling.median_value,Darts_styling.maxValue);

// # initial draw
let Dart_location = "Dart_plot";
Draw_Darts(layout_data,fill_data,Dart_location,Darts_styling);


// Global variables for current label type
let currentLabelType = "IUPHAR"; // Default

// Event listeners for label type buttons
document.getElementById("Dart_UniProtNames").addEventListener("click", () => {
    switchLabelType("UniProt");
});

document.getElementById("Dart_IUPHARNames").addEventListener("click", () => {
    switchLabelType("IUPHAR");
});

// Event listener for spacing toggle button
document.getElementById("ToggleSpacing").addEventListener("click", () => {
    // Toggle the spacing state
    Darts_styling.Spacing = !Darts_styling.Spacing;
    
    // Update the button text and state
    updateSpacingButtonState(Darts_styling.Spacing);

    // Redraw Darts with updated spacing
    updateDart();
});

// Event listener for spacing toggle button
document.getElementById("ToggleFamily").addEventListener("click", () => {
    // Toggle the spacing state
    Darts_styling.family = !Darts_styling.family;
    
    // Update the button text and state
    updateSpacingButtonState(Darts_styling.family);

    // Redraw Darts with updated spacing
    updateDart();
});

// Function to switch label types
function switchLabelType(labelType) {
    currentLabelType = labelType;
    updateDart();
}

// Function to update button active state for spacing
function updateSpacingButtonState(isFamily) {
    const button = document.getElementById("ToggleFamily");
    button.textContent = isFamily ? "On" : "Off";
    button.classList.toggle("active", isFamily);
}

// Function to update button active state for spacing
function updateSpacingButtonState(isSpacing) {
    const button = document.getElementById("ToggleSpacing");
    button.textContent = isSpacing ? "On" : "Off";
    button.classList.toggle("active", isSpacing);
}

// Function to update and redraw Darts
function updateDart() {
    const updatedLayoutData = updateLayoutData(layout_data, Dart_Label_conversion_dict, currentLabelType);
    const updatedFillData = updateFillData(fill_data, Dart_Label_conversion_dict, currentLabelType);

    // Clear the existing SVG content
    d3.select("#" + Dart_location).select("svg").remove();

    // Redraw the Darts with the updated data
    Draw_Darts(updatedLayoutData, updatedFillData, Dart_location, Darts_styling);

    // Update button active states
    // updateActiveButtonState(currentLabelType);
}

// Function to update layout data
function updateLayoutData(layout_data, conversionDict, labelType) {
    const updatedData = {};

    Object.keys(layout_data).forEach(DartKey => {
        const Dart = layout_data[DartKey];
        updatedData[DartKey] = {};

        Object.keys(Dart).forEach(ligandType => {
            const receptors = Dart[ligandType];
            updatedData[DartKey][ligandType] = receptors.map(receptor => {
                if (labelType === "UniProt") {
                    return conversionDict[receptor] || receptor;
                } else {
                    return Object.keys(conversionDict).find(key => conversionDict[key] === receptor) || receptor;
                }
            });
        });
    });

    return updatedData;
}

// Function to update fill data
function updateFillData(fill_data, conversionDict, labelType) {
    const updatedData = {};

    Object.keys(fill_data).forEach(receptor => {
        let updatedReceptor;
        if (labelType === "UniProt") {
            updatedReceptor = conversionDict[receptor] || receptor;
        } else {
            updatedReceptor = Object.keys(conversionDict).find(key => conversionDict[key] === receptor) || receptor;
        }
        updatedData[updatedReceptor] = fill_data[receptor];
    });

    return updatedData;
}



</script>
{% endif %}

{% endblock %}
