{% extends "home/base.html" %}
{% load static %}
{% load structure_extras %}

{% block addon_css %}
    <link rel="stylesheet" href="{% static 'home/css/jquery.dataTables.min.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'home/css/simple_browser.css' %}" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
{% endblock %}

{% block content %}
<style>
canvas {
    border:2px solid #888888;
}
.col-md-3 {
    color: black;
}
</style>

<style>
.inline {display:inline;}
.graphcolor {
              display:inline-block;
              padding: 1px 5px;
              text-align: center;
              margin-left: 10px;
              vertical-align: middle;
              width: 20px;
              height: 20px;
              margin-top: 5px;}
</style>

<style>
    .tooltip {
        position: absolute;
        text-align: center;
        padding: 10px;
        background: #f8f8f8;
        border: 1px solid #ccc;
        border-radius: 4px;
        pointer-events: none;
    }
    .newrow {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    .legend-header {
      font-family: Arial;
      font-size: 14px;
      font-weight: bold;
      fill: black;
    }
    path.highlight {
      stroke-width: 2;
    }
    .checkbox-group {
      display: flex;
    }

    .checkbox-item {
      display: inline-block;
      margin-right: 10px;  /* Add right margin */
      font-size: 18px;
    }
    .dotted {
      stroke-dasharray: 5,5;
    }
    .checkbox-item:last-child {
      margin-right: 0;  /* Remove right margin for the last item */
    }
</style>

<div class="row text-success">
    <div class="text-center">
        {% if model.receptor_protein.accession %}
            <h2>{{ model.protein_conformation.protein.entry_name|safe }} - {{ model.signprot_complex.protein.entry_name|safe }} complex homology model</h2>
        {% else %}
            <h2>{{ model.protein_conformation.protein.entry_name|upper }} refined </h2>
        {% endif %}
    </div>
</div>

<div class="row">
    <div class="col-md-3 text-right text-info">
        <h4>RECEPTOR CLASS</h4>
    </div>
    <div class="col-md-9">
        {{ model.protein_conformation.protein.get_protein_class }}
    </div>
</div>

<div class="row">
    <div class="col-md-3 text-right text-info">
        <h4>RECEPTOR</h4>
    </div>
    <div class="col-md-9">
        {% if model.protein_conformation.protein.accession %}
            <a href="/protein/{{ model.receptor_protein.entry_name }}">{{ model.protein_conformation.protein.name|safe }}</a>
        {% else %}
            <a href="/protein/{{ model.receptor_protein.parent.entry_name }}">{{ model.protein_conformation.protein.parent.name|safe }}</a>
        {% endif %}
    </div>
</div>

<div class="row">
    <div class="col-md-3 text-right text-info">
        <h4>SPECIES</h4>
    </div>
    <div class="col-md-9">
        {{ model.protein_conformation.protein.species.latin_name }}
    </div>
</div>

<div class="row">
    <div class="col-md-3 text-right text-info">
        <h4>G-PROTEIN FAMILY</h4>
    </div>
    <div class="col-md-9">
        {{ model.signprot_complex.protein.family.parent|safe }}
    </div>
</div>

<div class="row">
    <div class="col-md-3 text-right text-info">
        <h4>G-PROTEIN</h4>
    </div>
    <div class="col-md-9">
        <a href="/protein/{{ model.sign_protein.entry_name }}">{{ model.signprot_complex.protein.name|safe }}</a>
    </div>
</div>

<div class="row">
    <div class="col-md-3 text-right text-info">
        <h4>VERSION</h4>
    </div>
    <div class="col-md-9">
    {{ model.publication_date|date:"Y-m-d" }}
    </div>
</div>

<div class="row">
    <div class="col-md-3 text-right text-info">
        <h4>MODEL</h4>
    </div>
    <div class="col-md-4">
      <div class="btn-group">
          <a href="/" class="dropdown-toggle btn btn-primary btn-mini" data-toggle="dropdown" role="button" aria-expanded="false">Download <span class='caret'></span></a>
          <ul class="dropdown-menu" role="menu" style="min-width:50%;">
              {% if not model.protein.accession %}
                  <li><a id="download_btn" href="./{{model.protein_conformation.protein.entry_name|upper}}_full/download_pdb">Full</a></li>
                  <li><a id="download_btn" href="./{{model.protein_conformation.protein.entry_name|upper}}_noloops/download_pdb">Without loops</a></li>
              {% else %}
                  <li><a id="download_btn" href="./{{model.protein_conformation.protein.entry_name}}_{{model.state.slug}}_full/download_pdb">Full</a></li>
                  <li><a id="download_btn" href="./{{model.protein_conformation.protein.entry_name}}_{{model.state.slug}}_noloops/download_pdb">Without loops</a></li>
              {% endif %}
          </ul>
      </div>
        <div>
            <p>PDB file contains GPCRdb generic numbers in the B-factor field of CA atoms</p>
        </div>
        <div style="float: left; width: 60%;">
            <div id="viewport" style="width:500px; height:400px;background-color: white;"></div>
            <div style="width:500px; background-color:#eaeaea; border-radius: 0px 0px 5px 5px;">
                <p style="padding: 2px 0px 2px 5px; font-size: 10px;"><button id="fullscreen">Full Screen</button><a href="https://github.com/arose/ngl"> NGL</a> is a WebGL based 3D viewer powered by <a href="https://mmtf.rcsb.org">MMTF</a>.</p>
            </div>
            <br>
        </div>
    </div>
    <div class="col-md-3">
        <br>
        <br>
        <br>
        <br>
        <div><h4>Model confidence <i class="fas fa-info-circle" data-html="true" data-toggle="popover" data-trigger="hover" data-placement="below" data-content="<b>Interpretation of AlphaFold models</b><br>The pLDDT score from Alphafold estimates the confidence of the placement of an individual residue in relation to its neighboring residues within a 15Ã… radius. The GPCRdb provides full-length models for nearly all human GPCRs, including receptors that comprise multiple domains. Therefore, one should take into account that, when a model consists of multiple domains, the relative placement of the domains with respect to each other can be erroneous even when the pLDDT score for a given domain is high."></i></h4></div>
        <div style='width: 90%; display:table; position:relative;'>
            <div style='display: table-cell;'>
              <div class="graphcolor" style="background-color: blue; "></div>
              <span style="margin-left: 5px; vertical-align: middle; padding-top: 5px;">Very high (pLDDT > 90)</span>
              <br>
              <div class="graphcolor" style="background-color: lightblue; "></div>
              <span style="margin-left: 5px; vertical-align: middle;">Confident (90 > pLDDT > 70)</span>
              <br>
              <div class="graphcolor" style="background-color: yellow; "></div>
              <span style="margin-left: 5px; vertical-align: middle;">Low (70 > pLDDT > 50)</span>
              <br>
              <div class="graphcolor" style="background-color: orange;"></div>
              <span style="margin-left: 5px; vertical-align: middle;">Very low (pLDDT < 50)</span>
              <br>
              <div class="graphcolor" style="background-color: red;"></div>
              <span style="margin-left: 5px; vertical-align: middle;">Disordered</span>
              <br>
            </div>
        </div>
        <br>
        <div>
          <h5>PTM Score
            <span class="fa fa-info-circle" data-html="true" data-toggle="popover" data-trigger="hover" data-placement="bottom" data-content="<b>Predicted TM-score </b>:<br /> is an estimate of the TM-score derived from comparing predicted atom positions
            to true positions under various alignments, emphasizing correct local frame residue interactions in AlphaFold."></span>
          </h5>
        </div>
        <div id="PTM_location"></div>
        <div>
          <h5>iPTM Score
            <span class="fa fa-info-circle" data-html="true" data-toggle="popover" data-trigger="hover" data-placement="bottom" data-content="<b>Interface predicted TM-score</b>:<br />
A modified pTM score, adapted to measure the accuracy of predicted protein interfaces Instead of comparing residues within the same protein chain as in the original TM-score, it compares residues from different chains."></span>
          </h5>
        </div>
        <div id="iPTM_location"></div>
        <div>
          <h5>PAE mean
            <span class="fa fa-info-circle" data-html="true" data-toggle="popover" data-trigger="hover" data-placement="bottom" data-content="The average expected error in residue x's position when aligning predicted and true structures based on residue y, focusing on inter-chain relationships."></span>
          </h5>
        </div>
        <div id="PAE_location"></div>
    </div>
</div>

<div class="row">
  <div class="col-md-3 text-right text-info">
    <h4>INTERACTING RESIDUES</h4>
  </div>
  <div class="col-md-9">
    <a href="/interaction/complex/{{pdbname}}"> {{residues}} interactions (Click to see)</a>
  </div>
</div>

<div class="col-md-12 ">
    <div id="tooltip" class="tooltip"></div>
    <div style="display: flex; justify-content: center;">
      <svg id="visualization" width="100%" height="1115"></svg>
    </div>
    <div class="row">
      <div class="col-md-3 text-right text-info">
      </div>
      <div class="col-md-9">
        <p><b>Highlight receptor-transducer interaction</b></p>
        <div class="checkbox-group">
          <div class="checkbox-item">
            <input type="checkbox" id="main-main" name="chain" value="Main-Main">
            <label for="main-main">Main-Main</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="main-side" name="chain" value="Main-Side">
            <label for="main-side">Main-Side</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="side-side" name="chain" value="Side-Side">
            <label for="side-side">Side-Side</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="side-main" name="chain" value="Side-Main">
            <label for="side-main">Side-Main</label>
          </div>
        </div>
        <br/>
        <div style="text-align: left;">
          <button id="interactionsButton">Interactions</button>
          <button id="propertiesButton">Properties</button>
          <button id="segmentButton">Segment</button>
          <button id="resetButton">Reset</button>
        </div>
        <br/>
        <div style="text-align: left;">
          <div class="btn-group">
              <button type="button" class="btn btn-sm btn-primary dropdown-toggle" data-toggle="dropdown"
                      aria-haspopup="true" aria-expanded="false">
                  <span class="glyphicon glyphicon-download"></span> Download <span class="caret"></span>
              </button>
              <ul class="dropdown-menu">
                  <li>
                      <a href="javascript:downloadSVG('visualization', 'interactionsPNG', 'png');">PNG</a>
                  </li>
                  <li>
                      <a href="javascript:downloadSVG('visualization', 'interactionsJPEG', 'jpeg');">JPEG</a>
                  </li>
                  <li>
                      <a href="javascript:downloadSVG('visualization', 'interactionsTIFF', 'tiff');">TIFF</a>
                  </li>
                  <li>
                      <a href="javascript:downloadSVG('visualization', 'interactionsSVG');">SVG</a>
                  </li>
              </ul>
          </div>
        </div>
      </div>
      <br>
      <br>
    </div>

</div>

{% if refined %}
<div class="row">
    <div class="col-md-3 text-right text-info">
        <h4>RECEPTOR TEMPLATES</h4>
    </div>
    <style>
        .table-th {
            background:#eaeaea;
            border-bottom:1px solid #9ea7af;
            border-right: 1px solid #9ea7af;
            padding:5px;
            font-size: 12px;
            text-align:left;
            vertical-align:middle;
        }
        .table-td {
            text-align:center;
            border-right: 1px solid #9ea7af;
        }
    </style>
    <div class="col-md-9">
        <div style='width: 70%; display:table; position:relative;'>
            <div style='display: table-cell;'>
                {% for prot, bts in backbone_templates.items %}
                    {% for bt in bts %}
                        <div class="graphcolor" style="background-color:{{ bt.color }}; width: 20px; height: 10px; margin-bottom: 5px; border:solid black;"></div>
                        {{ bt.pdb_code.index }} ({{ bt.protein_conformation.protein.parent.name|safe}}) <br>


                    {% endfor %}
                {% endfor %}
                        <div class="graphcolor" style="background-color:white; width: 20px; height: 10px; margin-bottom: 5px; border:solid black;"></div>
                        None
            </div>
        </div>
        <table>
            <thead>
                <tr>
                    <th class='table-th'></th>
                    <th class='table-th'>Main template (%)</th>
                    <th class='table-th'>Additional templates (%)</th>
                    <th class='table-th' style="border-right: 0px;">No template - freely modelled (%)</th>
            </thead>
            <tbody>
                <tr>
                    <td style="border-right: 1px solid #9ea7af; text-align:right; padding: 3px; font-size: 12px;">Backbone</td>
                    <td class="table-td">{{bb_main}}</td>
                    <td class="table-td">{{bb_alt}}</td>
                    <td class="table-td" style="border-right: 0px;">{{bb_none}}</td>
                </tr>
                <tr>
                    <td style="border-right: 1px solid #9ea7af; text-align:right; padding: 3px; font-size: 12px;">Side-chains</td>
                    <td class="table-td">{{sc_main}}</td>
                    <td class="table-td">{{sc_alt}}</td>
                    <td class="table-td" style="border-right: 0px;">{{sc_none}}</td>
                </tr>
            </tbody>
        </table>
        <br>
        Number of backbone templates: {{ backbone_templates_number }}<br>
        Number of rotamer templates: {{ rotamer_templates_number }}<br><br>

        <style>
            table.dataTable thead th {padding: 3px 1px 3px 3px;}
        </style>
        <div style="padding-top: 0px; font-size: 10px; white-space: nowrap; width: 50%;">
            <table class="display" id="rotamers">
                <thead>
                    <tr>
                        <th>Segment</th>
                        <th>Seq.num.</th>
                        <th>AA</th>
                        <th>GPCRdb#</th>
                        <th>Backbone</th>
                        <th>PDB</th>
                        <th>Rotamer</th>
                        <th>PDB</th>
                    </tr>
                    <tr>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                {% for rota in receptor_rotamers %}
                    <tr>
                        <td>{{ rota.residue.protein_segment.slug }}</td>
                        <td>{{ rota.residue.sequence_number }}</td>
                        <td>{{ rota.residue.amino_acid }}</td>
                        {% if rota.residue.display_generic_number %}
                            <td>{{ rota.residue.display_generic_number.label }}</td>
                        {% else %}
                            <td>-</td>
                        {% endif %}
                        {% if rota.backbone_template %}
                            <td><a href="/protein/{{ rota.backbone_template.protein_conformation.protein.parent.entry_name }}">{{ rota.backbone_template.protein_conformation.protein.parent.name|safe }}</a></td>
                            <td><a href="../{{ rota.backbone_template.pdb_code.index }}">{{ rota.backbone_template.pdb_code.index }}</a></td>
                        {% else %}
                            <td>-</td>
                            <td>-</td>
                        {% endif %}
                        {% if rota.rotamer_template %}
                            <td><a href="/protein/{{ rota.rotamer_template.protein_conformation.protein.parent.entry_name }}">{{ rota.rotamer_template.protein_conformation.protein.parent.name|safe }}</a></td>
                            <td><a href="../{{ rota.rotamer_template.pdb_code.index }}">{{ rota.rotamer_template.pdb_code.index }}</a></td>
                        {% else %}
                            <td>-</td>
                            <td>-</td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<br>
<div class="row">
    <div class="col-md-3 text-right text-info">
        <h4>G-PROTEIN TEMPLATES</h4>
    </div>
    <div class="col-md-9">
        <style>
            table.dataTable thead th {padding: 3px 1px 3px 3px;}
        </style>
        <div style="padding-top: 0px; font-size: 10px; white-space: nowrap; width: 50%;">
            <table class="display" id="signprot_rotamers">
                <thead>
                    <tr>
                        <th>Segment</th>
                        <th>Seq.num.</th>
                        <th>AA</th>
                        <th>CGN#</th>
                        <th>Backbone</th>
                        <th>PDB</th>
                        <th>Rotamer</th>
                        <th>PDB</th>
                    </tr>
                    <tr>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                {% for rota in signprot_rotamers %}
                    <tr>
                        <td>{{ rota.residue.protein_segment.slug }}</td>
                        <td>{{ rota.residue.sequence_number }}</td>
                        <td>{{ rota.residue.amino_acid }}</td>
                        <td>{{ rota.residue.generic_number.label }}</td>
                        {% if rota.backbone_template %}
                            <td><a href="/signprot/{{ rota.backbone_template.signprot_complex.protein.entry_name }}"> {{ rota.backbone_template.signprot_complex.protein.name}}</a></td>
                            <td><a href="../{{ rota.backbone_template.pdb_code.index }}">{{ rota.backbone_template.pdb_code.index }}</a></td>
                        {% else %}
                            <td>-</td>
                            <td>-</td>
                        {% endif %}
                        {% if rota.rotamer_template %}
                            <td><a href="/signprot/{{ rota.rotamer_template.signprot_complex.protein.entry_name }}"> {{ rota.rotamer_template.signprot_complex.protein.name}}</a></td>
                            <td><a href="../{{ rota.rotamer_template.pdb_code.index }}">{{ rota.rotamer_template.pdb_code.index }}</a></td>
                        {% else %}
                            <td>-</td>
                            <td>-</td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<br>
<style>
.inline {display:inline;}
.graphcolor { display:inline-block; border-style:solid; border-width: 1px; padding: 1px 5px; text-align: center}
</style>

{% endblock %}
{% block addon_js %}
    <script src="{% static 'home/js/ngl.js' %}"> </script>
    <script>
        document.addEventListener( "DOMContentLoaded", function(){
            stage = new NGL.Stage( "viewport", { backgroundColor: "white" } );
            var color_residues = JSON.parse('{{color_residues|safe}}');

            var schemeId = NGL.ColorMakerRegistry.addSelectionScheme( color_residues );

            stage.loadFile( "/structure/complex_models/view/{{pdbname}}", { ext: "pdb" }  ).then( function( o ){
                o.addRepresentation( "cartoon", {color: schemeId} );  // pass schemeId here ,{ color: schemeId }
                o.centerView();
            } );
        } );

        $( "#fullscreen" ).click(function() {
            stage.toggleFullscreen();
        });
    </script>

    <script src="{% static 'home/js/d3.min.js' %}"></script>
    <script src="{% static 'home/js/nv.d3.min.js' %}"></script>
    <script src="{% static 'home/js/d3.v4.min.js' %}"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="{% static 'home/js/jquery.dataTables.min.js' %}"> </script>
    <script src="{% static 'home/js/dataTables.tableTools.min.js' %}"> </script>
    <script src="{% static 'home/js/jquery.dataTables.columnFilter.js' %}"> </script>
    <script src="{% static 'home/js/selection.js' %}"> </script>
    <script src="{% static 'home/js/table2csv.js' %}"> </script>
    <script src="{% static 'home/js/phylo_tree.js' %}"></script>
    <script>
      $(function () {
        $("[data-toggle='popover']").popover();
      });
    </script>
    <script type="text/javascript" charset="utf-8">
        $(document).ready(function () {
            ptm = {{ scores.ptm }};
            iptm = {{ scores.iptm }};
            pae = {{ scores.pae_mean }};
            interactions = {{ interactions | safe }};
            inner_data = {{ inner | safe }};
            outer_data = {{ outer | safe }};

            ClearSelection('targets');
            ClearSelection('reference');
            // Call the function with your desired values
            // function draw_model_scores(location, element_id, legend_label, score, startValue, endValue, definedValue
            draw_model_scores('PTM_location', 'PTM_divider', 'PTM',  0, 1, ptm, 0.5);
            draw_model_scores('iPTM_location', 'iPTM_divider', 'iPTM',  0, 1, iptm, 0.2);
            draw_model_scores('PAE_location', 'PAE_divider', 'PAE',  0, 31, pae, 26, true);
            draw_interactions_in_circles('visualization', interactions, inner_data, outer_data);
            // Function to update the highlight based on checkbox selections
            function updateHighlight() {
              // Get all selected checkbox values
              const selectedChains = Array.from(document.querySelectorAll('input[name="chain"]:checked'))
                                          .map(el => el.value);
              // Reset all path highlights
              d3.selectAll('path').classed('highlight', false);
              d3.selectAll("path")
                .each(function(d, i) {
                  const segment = d3.select(this).attr("segment");
                  if (!segment) {
                    d3.select(this).attr("stroke-opacity", 0);
                    d3.select(this).attr("stroke-width", 4);
                  }
                });
              // d3.selectAll("path").attr("stroke-opacity", 0);
              // Loop through selected checkbox combinations
              selectedChains.forEach(chain => {
                const [outerChain, innerChain] = chain.split('-');

                // Highlight the selected paths
                d3.selectAll(`path[inner-chain="${innerChain}"][outer-chain="${outerChain}"]`)
                  .attr("stroke-opacity", 1)
                  .attr("stroke-width", 4);
              });
            }
            // Attach event listeners to checkboxes
            document.querySelectorAll('input[name="chain"]').forEach(el => {
              el.addEventListener('change', updateHighlight);
            });
            var table = $('#rotamers').DataTable({
                'scrollX': true,
                'scrollY': '15vh',
                'bScrollCollapse': true,
                'paging': false,
                'orderCellsTop': true,
                'autoWidth': false,
                'dom': 'iTlfrt',
                'order': [[1, "asc"]], // order by date

                'tableTools': {
                    "sRowSelect": "single",
                    "aButtons": []
                },

                initComplete: function () {
                    $('#rotamers').dataTable().columnFilter({
                        sPlaceHolder: "head:after",
                        sRangeFormat: "{from}:{to}",
                        aoColumns: [
                            { type: "select" }, // segment
                            { type: "number-range"}, // seq num
                            { type: "text" }, // AA
                            { type: "text" }, // gn
                            { type: "text" }, // backbone
                            { type: "text" }, // backbone xtal
                            { type: "text" }, // rotamer
                            { type: "text" }, // rotamer xtal
                        ]
                    });
                },
            });
            var table2 = $('#signprot_rotamers').DataTable({
                'scrollX': true,
                'scrollY': '15vh',
                'bScrollCollapse': true,
                'paging': false,
                'orderCellsTop': true,
                'autoWidth': false,
                'dom': 'iTlfrt',
                'order': [[1, "asc"]], // order by date

                'tableTools': {
                    "sRowSelect": "single",
                    "aButtons": []
                },

                initComplete: function () {
                    $('#signprot_rotamers').dataTable().columnFilter({
                        sPlaceHolder: "head:after",
                        sRangeFormat: "{from}:{to}",
                        aoColumns: [
                            { type: "select" }, // segment
                            { type: "number-range"}, // seq num
                            { type: "text" }, // AA
                            { type: "text" }, // gn
                            { type: "text" }, // backbone
                            { type: "text" }, // backbone xtal
                            { type: "text" }, // rotamer
                            { type: "text" }, // rotamer xtal
                        ]
                    });
                },
            });
            $('#align_btn1').click(function () {
                ClearSelection("targets");
                AddToSelection("targets", "structure_complex_receptor", "{{model.receptor_protein.entry_name}}-{{model.sign_protein.entry_name}}");
                AddToSelection("targets", "structure", "{{model.main_template}}");

                window.location.href = '/structure/selection_convert_model';
            });
            $('#align_btn2').click(function () {
                ClearSelection('targets');
                AddToSelection('targets', 'structure_complex_signprot', "{{model.sign_protein.entry_name}}");
                AddToSelection('targets', 'structure', "{{model.main_template.pdb_code.index}}");

                window.location.href = '/structure/selection_convert_signprot_model';
            });
            $('#superpose_btn').click(function () {
                var table2 = Array.from("{{template_list}}".split(","));
                var template_list = []
                for (i=0; i<table2.length; i++) {
                    template_list.push(table2[i].replace("&#39;","").replace("&#39;",""))
                }
                ClearSelection('targets');
                ClearSelection('reference');
                var div = document.createElement("div");

                div.innerHTML = "{{model.receptor_protein.entry_name}}";
                if (typeof div.innerText !== "undefined") {
                    AddToSelection('reference', 'structure_complex_receptor', div.innerText.replace(/\s+/g, '').replace('[','').replace(']',''));
                } else {
                    AddToSelection('reference', 'structure_complex_receptor', div.textContent.replace(/\s+/g, '').replace('[','').replace(']',''));
                }

                for (i = 0; i < template_list.length; i++) {
                    var div = document.createElement("div");
                    div.innerHTML = template_list[i];
                    if (typeof div.innerText !== "undefined") {
                        AddToSelection('targets', 'structure', div.innerText.replace(/\s+/g, '').replace('[','').replace(']',''));
                    } else {
                        AddToSelection('targets', 'structure', div.textContent.replace(/\s+/g, '').replace('[','').replace(']',''));
                    }

                }
                window.location.href = '/structure/superposition_workflow_index';
            });
        });

        function downloadCSV() {
          $('#rotamers').table2csv({filename: 'Complex_model_templates.csv', quoteFields: true});
        }
        function downloadSVG(svgElementId, filename, format = 'svg') {
          const svgElement = document.getElementById(svgElementId);

          if (!svgElement) {
            console.error(`Element with id "${svgElementId}" not found.`);
            return;
          }

          if (format === 'svg') {
            const svgString = new XMLSerializer().serializeToString(svgElement);
            const blob = new Blob([svgString], { type: "image/svg+xml;charset=utf-8" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = filename + '.svg';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          } else {
            const svgString = new XMLSerializer().serializeToString(svgElement);
            const img = new Image();
            img.src = 'data:image/svg+xml;base64,' + window.btoa(svgString);
            img.onload = function() {
              const canvas = document.createElement('canvas');
              const bbox = svgElement.getBBox();
              canvas.width = bbox.width * 1.2;
              canvas.height = bbox.height * 1.2;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0);
              let mimeType = 'image/png';
              if (format === 'jpeg') mimeType = 'image/jpeg';
              else if (format === 'tiff') mimeType = 'image/tiff';
              canvas.toBlob((blob) => {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename + '.' + format;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
              }, mimeType);
            };
          }
        }

    </script>

{% endblock %}
